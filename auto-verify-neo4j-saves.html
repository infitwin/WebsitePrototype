<!DOCTYPE html>
<html>
<head>
    <title>Auto Verify Neo4j Saves</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .log { margin: 5px 0; }
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #44aaff; }
        pre { background: #333; padding: 10px; border-radius: 4px; overflow: auto; }
    </style>
</head>
<body>
    <h1>ü§ñ Automated Neo4j Save Verification</h1>
    <div id="log"></div>
    
    <!-- Neo4j Driver -->
    <script src="https://unpkg.com/neo4j-driver@5.15.0/lib/browser/neo4j-web.min.js"></script>
    <script src="js/neo4j-connection.js"></script>
    
    <script>
        let logContainer;
        let testResults = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().substr(11, 12);
            const entry = document.createElement('div');
            entry.className = `log ${type}`;
            entry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            console.log(`[${timestamp}] ${message}`);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function logObject(label, obj, type = 'info') {
            log(`${label}:`, type);
            const pre = document.createElement('pre');
            pre.className = type;
            pre.textContent = JSON.stringify(obj, null, 2);
            logContainer.appendChild(pre);
        }
        
        async function connectToNeo4j() {
            log('üîå Connecting to Neo4j...', 'info');
            try {
                const connected = await window.Neo4jConnection.connect();
                if (!connected) {
                    throw new Error('Connection failed');
                }
                log('‚úÖ Connected to Neo4j', 'success');
                return true;
            } catch (error) {
                log(`‚ùå Neo4j connection failed: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function queryNeo4jDirectly(nodeId) {
            log(`üîç Querying Neo4j directly for node: ${nodeId}`, 'info');
            const session = window.Neo4jConnection.getSession();
            try {
                const result = await session.run(
                    'MATCH (n {id: $nodeId}) RETURN n',
                    { nodeId }
                );
                
                if (result.records.length === 0) {
                    return null;
                }
                
                const node = result.records[0].get('n');
                return node.properties;
            } finally {
                await session.close();
            }
        }
        
        async function testNodeSave() {
            const testId = `auto_test_node_${Date.now()}`;
            
            log('üìù Testing Node Save...', 'info');
            
            // Data to save
            const saveData = {
                name: 'Test Person',
                type: 'Person',
                age: 30,
                occupation: 'Engineer',
                stateMaps: [
                    {
                        id: 'state_1',
                        description: 'Early career',
                        startDate: '2020-01-01',
                        endDate: '2023-12-31'
                    },
                    {
                        id: 'state_2',
                        description: 'Senior role',
                        context: 'Promoted to senior engineer'
                    }
                ]
            };
            
            logObject('üì§ Data being saved', saveData, 'info');
            
            try {
                // Save via our connection layer
                const savedResult = await window.Neo4jConnection.updateSandboxNode(
                    testId,
                    saveData,
                    [],
                    'auto_test_user',
                    'auto_test_twin',
                    'auto_test_interview'
                );
                
                logObject('üì• Save result returned', savedResult, 'success');
                
                // Query directly from Neo4j
                const directQuery = await queryNeo4jDirectly(testId);
                logObject('üîé Direct Neo4j query result', directQuery, 'info');
                
                // Compare the data
                return compareData(saveData, savedResult, directQuery, 'Node');
                
            } catch (error) {
                log(`‚ùå Node save test failed: ${error.message}`, 'error');
                return { passed: false, error: error.message };
            }
        }
        
        async function testRelationshipSave() {
            const testId = `auto_test_rel_${Date.now()}`;
            
            log('üîó Testing Relationship Save...', 'info');
            
            // Data to save
            const saveData = {
                sourceId: 'person_1',
                targetId: 'person_2',
                category: 'ORGANIZATIONAL',
                type: 'EMPLOYED_BY',
                stateMaps: [
                    {
                        id: 'employment_state_1',
                        role: 'Software Engineer',
                        department: 'Engineering',
                        startDate: '2020-01-01',
                        endDate: '2023-06-30',
                        salary: 120000
                    },
                    {
                        id: 'employment_state_2',
                        role: 'Senior Software Engineer',
                        department: 'Platform',
                        startDate: '2023-07-01',
                        description: 'Promoted to senior role'
                    }
                ]
            };
            
            logObject('üì§ Relationship data being saved', saveData, 'info');
            
            try {
                // Save via our connection layer
                const savedResult = await window.Neo4jConnection.updateSandboxNode(
                    testId,
                    saveData,
                    [],
                    'auto_test_user',
                    'auto_test_twin',
                    'auto_test_interview'
                );
                
                logObject('üì• Relationship save result', savedResult, 'success');
                
                // Query directly from Neo4j
                const directQuery = await queryNeo4jDirectly(testId);
                logObject('üîé Direct Neo4j query result', directQuery, 'info');
                
                // Compare the data
                return compareData(saveData, savedResult, directQuery, 'Relationship');
                
            } catch (error) {
                log(`‚ùå Relationship save test failed: ${error.message}`, 'error');
                return { passed: false, error: error.message };
            }
        }
        
        function compareData(original, saveResult, directQuery, type) {
            log(`üîç Comparing ${type} data...`, 'info');
            
            const issues = [];
            
            // Check if save result matches original data
            if (saveResult.stateMaps) {
                if (Array.isArray(saveResult.stateMaps)) {
                    log('‚úÖ Save result: stateMaps is array', 'success');
                    if (JSON.stringify(saveResult.stateMaps) === JSON.stringify(original.stateMaps)) {
                        log('‚úÖ Save result: stateMaps content matches original', 'success');
                    } else {
                        log('‚ö†Ô∏è Save result: stateMaps content differs from original', 'warning');
                        issues.push('Save result stateMaps differs from original');
                    }
                } else {
                    log(`‚ùå Save result: stateMaps is ${typeof saveResult.stateMaps}, not array`, 'error');
                    issues.push(`Save result stateMaps is ${typeof saveResult.stateMaps}`);
                }
            } else {
                log('‚ö†Ô∏è Save result: no stateMaps found', 'warning');
                issues.push('Save result missing stateMaps');
            }
            
            // Check direct Neo4j query
            if (directQuery) {
                if (directQuery.stateMaps) {
                    if (typeof directQuery.stateMaps === 'string') {
                        log('‚úÖ Direct query: stateMaps stored as string', 'success');
                        try {
                            const parsed = JSON.parse(directQuery.stateMaps);
                            if (JSON.stringify(parsed) === JSON.stringify(original.stateMaps)) {
                                log('‚úÖ Direct query: parsed stateMaps matches original', 'success');
                            } else {
                                log('‚ö†Ô∏è Direct query: parsed stateMaps differs from original', 'warning');
                                issues.push('Direct query parsed stateMaps differs');
                                logObject('Expected', original.stateMaps, 'warning');
                                logObject('Actual', parsed, 'warning');
                            }
                        } catch (e) {
                            log(`‚ùå Direct query: failed to parse stateMaps JSON: ${e.message}`, 'error');
                            issues.push('Direct query stateMaps JSON parse failed');
                        }
                    } else {
                        log(`‚ùå Direct query: stateMaps is ${typeof directQuery.stateMaps}, not string`, 'error');
                        issues.push(`Direct query stateMaps is ${typeof directQuery.stateMaps}`);
                    }
                } else {
                    log('‚ùå Direct query: no stateMaps found', 'error');
                    issues.push('Direct query missing stateMaps');
                }
            } else {
                log('‚ùå Direct query: node not found in Neo4j', 'error');
                issues.push('Node not found in Neo4j');
            }
            
            const passed = issues.length === 0;
            return {
                passed,
                issues,
                type,
                original,
                saveResult,
                directQuery
            };
        }
        
        async function runAllTests() {
            log('üöÄ Starting automated Neo4j save verification...', 'info');
            
            // Connect first
            const connected = await connectToNeo4j();
            if (!connected) {
                log('‚ùå Cannot run tests without Neo4j connection', 'error');
                return;
            }
            
            // Run tests
            log('üìã Running test suite...', 'info');
            
            const nodeTest = await testNodeSave();
            testResults.push(nodeTest);
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // Brief pause
            
            const relationshipTest = await testRelationshipSave();
            testResults.push(relationshipTest);
            
            // Summary
            log('üìä Test Results Summary:', 'info');
            
            let allPassed = true;
            testResults.forEach((result, i) => {
                if (result.passed) {
                    log(`‚úÖ Test ${i + 1} (${result.type}): PASSED`, 'success');
                } else {
                    log(`‚ùå Test ${i + 1} (${result.type}): FAILED`, 'error');
                    if (result.error) {
                        log(`   Error: ${result.error}`, 'error');
                    }
                    if (result.issues) {
                        result.issues.forEach(issue => {
                            log(`   Issue: ${issue}`, 'error');
                        });
                    }
                    allPassed = false;
                }
            });
            
            if (allPassed) {
                log('üéâ ALL TESTS PASSED - Neo4j save/retrieve working correctly!', 'success');
            } else {
                log('üí• SOME TESTS FAILED - Issues detected in save/retrieve process', 'error');
            }
            
            log('üèÅ Automated verification complete', 'info');
        }
        
        // Auto-start when page loads
        window.addEventListener('load', () => {
            logContainer = document.getElementById('log');
            log('ü§ñ Auto-verification system starting...', 'info');
            
            // Start tests after brief delay
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>