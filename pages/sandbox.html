<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandbox - Infitwin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/components/navigation.css">
    
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            color: #1a1a1a;
            overflow: hidden;
            height: 100vh;
        }

        /* Main layout container */
        .symphony-dashboard {
            display: flex;
            height: 100vh;
        }

        /* Shared Navigation Sidebar - handled by navigation.css */
        .sidebar-nav-container {
            width: 80px;
            flex-shrink: 0;
            z-index: 200;
        }

        /* Main content wrapper */
        .main-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* App Header */
        .sandbox-header {
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-left h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .container {
            height: 100%;
            position: relative;
        }
        
        /* Smart Context Bar */
        .context-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            z-index: 999;
            transform: translateY(40px);
            opacity: 0;
            transition: transform 200ms ease, opacity 200ms ease;
        }
        
        .context-bar.visible {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Toolbar */
        .toolbar {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            display: flex;
            gap: 5px;
            padding: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1100;
        }
        
        .toolbar-btn {
            width: 45px;
            height: 45px;
            border: 2px solid #dee2e6;
            background: #f8f9fa;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .toolbar-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        /* Content Area */
        .content-area {
            padding: 20px;
            height: 100%;
        }
        
        .sandbox-panel {
            width: 100%;
            height: calc(100% - 40px);
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .sandbox-container {
            width: 100%;
            height: calc(100% - 50px);
            border: 2px solid #007bff;
            border-radius: 6px;
            background: #fafafa;
        }
        
        /* Floating Panel Base Styles */
        .floating-panel {
            position: fixed;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            cursor: default;
            backdrop-filter: blur(5px);
            resize: both;
            overflow: auto;
            min-width: 200px;
            min-height: 150px;
        }
        
        .floating-panel.open {
            display: block;
        }
        
        .floating-panel.dragging {
            opacity: 0.7;
            z-index: 1200;
        }
        
        /* Resize handle styling */
        .floating-panel::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 15px;
            height: 15px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, #dee2e6 50%);
            border-radius: 0 0 8px 0;
        }
        
        /* Panel Header */
        .panel-header {
            cursor: move;
            user-select: none;
            padding: 12px 15px;
            margin: -20px -20px 15px -20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .panel-header:hover {
            background: #e9ecef;
        }
        
        .panel-close {
            width: 24px;
            height: 24px;
            border: none;
            background: none;
            color: #666;
            cursor: pointer;
            border-radius: 4px;
            font-size: 18px;
            line-height: 1;
        }
        
        .panel-close:hover {
            background: rgba(0,0,0,0.1);
        }
        
        /* Specific Panel Positioning and Sizes */
        .node-list-panel {
            top: 140px;
            left: 120px;
            width: 300px;
            height: 600px;
        }
        
        .ai-assistant-panel {
            bottom: 60px;
            left: 120px;
            width: 300px;
            height: 400px;
        }
        
        .faces-panel {
            top: 140px;
            left: 440px;
            width: 280px;
            height: 400px;
        }
        
        .artifacts-panel {
            top: 140px;
            right: 20px;
            width: 320px;
            height: 450px;
        }
        
        .production-panel {
            top: 140px;
            right: 360px;
            width: 500px;
            height: 400px;
            flex-direction: column;
        }
        
        .production-panel.open {
            display: flex;
        }
        
        .tools-panel {
            bottom: 60px;
            right: 20px;
            width: 250px;
            height: 250px;
        }
        
        .production-container {
            width: 100%;
            height: 380px;
            border: 2px solid #28a745;
            border-radius: 6px;
            background: #fafafa;
        }
        
        /* Firebase Dropdown Styles */
        .firebase-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .firebase-dropdown-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .firebase-dropdown-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .firebase-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 5px;
            background: white;
            min-width: 250px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 6px;
            z-index: 2000;
            color: #333;
        }
        
        .firebase-dropdown-content.show {
            display: block;
        }
        
        .firebase-dropdown-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
        }
        
        .firebase-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        
        .firebase-dropdown-item:hover {
            background: #f5f5f5;
        }
        
        .firebase-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #666;
        }
        
        .firebase-status.connected {
            color: #28a745;
        }
        
        /* Artifact Thumbnail Styles */
        .artifact-thumbnail {
            width: 100px;
            height: 100px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: grab;
            overflow: hidden;
            position: relative;
            transition: all 0.2s;
        }
        
        .artifact-thumbnail:hover {
            border-color: #fd7e14;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .artifact-thumbnail.dragging {
            cursor: grabbing;
            opacity: 0.5;
        }
        
        .artifact-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .artifact-thumbnail-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            background: #f8f9fa;
        }
        
        .artifact-thumbnail-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px;
            font-size: 10px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Face thumbnails */
        .face-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            cursor: grab;
            position: relative;
            background: white;
            border: 2px solid #dee2e6;
            transition: all 0.2s;
        }
        
        .face-thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #6f42c1;
        }
        
        .face-thumbnail.dragging {
            cursor: grabbing;
            opacity: 0.5;
        }
        
        .face-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .face-thumbnail-confidence {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 4px;
            font-size: 9px;
            border-radius: 3px;
            font-weight: 600;
        }
        
        .face-thumbnail-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px;
            font-size: 9px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="symphony-dashboard">
        <!-- Shared Navigation Sidebar -->
        <div class="sidebar-nav-container"></div>
        
        <!-- Main Content Wrapper -->
        <div class="main-content-wrapper">
        <!-- App Header -->
        <div class="sandbox-header">
            <div class="header-left">
                <span style="font-size: 20px;">üß™</span>
                <h1>Sandbox - Graph Editor</h1>
            </div>
            <div class="header-right">
                <span>Session: active</span>
                <span>Status: ready</span>
                
                <!-- Firebase Dropdown -->
                <div class="firebase-dropdown">
                    <button class="firebase-dropdown-btn" onclick="toggleFirebaseDropdown()">
                        üî• Firebase
                        <span style="font-size: 10px;">‚ñº</span>
                    </button>
                    <div class="firebase-dropdown-content" id="firebaseDropdown">
                        <div class="firebase-dropdown-header">
                            Firebase Integration
                            <div class="firebase-status connected" id="firebaseStatus">
                                <span style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; display: inline-block;"></span>
                                <span id="firebaseStatusText">Disconnected</span>
                            </div>
                        </div>
                        <div class="firebase-dropdown-item" onclick="syncToFirebase()">
                            <span>üì§</span>
                            <div>
                                <div>Sync to Firebase</div>
                                <div style="font-size: 11px; color: #666;">Save sandbox changes to Firestore</div>
                            </div>
                        </div>
                        <div class="firebase-dropdown-item" onclick="loadFromFirebase()">
                            <span>üì•</span>
                            <div>
                                <div>Load from Firebase</div>
                                <div style="font-size: 11px; color: #666;">Restore previous session</div>
                            </div>
                        </div>
                        <div class="firebase-dropdown-item" onclick="uploadArtifacts()">
                            <span>üìé</span>
                            <div>
                                <div>Upload Artifacts</div>
                                <div style="font-size: 11px; color: #666;">Store files in Firebase Storage</div>
                            </div>
                        </div>
                        <div class="firebase-dropdown-item" onclick="viewFirebaseData()">
                            <span>üìä</span>
                            <div>
                                <div>View Data</div>
                                <div style="font-size: 11px; color: #666;">Browse Firestore collections</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Smart Context Bar -->
        <div class="context-bar" id="contextBar">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span>‚ú®</span>
                <span id="changesText">0 changes pending in sandbox</span>
            </div>
            <span style="font-size: 12px; opacity: 0.9;">
                Review changes before posting to production
            </span>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="container">
                <!-- Toolbar -->
                <div class="toolbar">
                    <button class="toolbar-btn" title="Node List" onclick="togglePanel('node-list')">üìã</button>
                    <button class="toolbar-btn" title="Faces" onclick="togglePanel('faces')">üë§</button>
                    <button class="toolbar-btn" title="Artifacts" onclick="togglePanel('artifacts')">üìé</button>
                    <button class="toolbar-btn" title="Production Graph" onclick="togglePanel('production')">üîµ</button>
                    <button class="toolbar-btn active" title="AI Assistant" onclick="togglePanel('ai-assistant')">ü§ñ</button>
                    <button class="toolbar-btn" title="Tools" onclick="togglePanel('tools')">üõ†Ô∏è</button>
                </div>
                
                <div class="content-area">
                    <div class="sandbox-panel">
                        <h3 style="margin: 0 0 15px 0; color: #007bff;">üîß Sandbox Control</h3>
                        <div id="sandboxContainer" class="sandbox-container"></div>
                    </div>
                </div>
                
                <!-- Node List Panel -->
                <div id="node-listPanel" class="floating-panel node-list-panel">
                    <div class="panel-header" id="node-listHeader">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>üìã</span>
                            <span style="font-weight: 600; color: #007bff;">Node List</span>
                        </div>
                        <button onclick="togglePanel('node-list')" class="panel-close">√ó</button>
                    </div>
                    <div style="flex: 1; overflow-y: auto; background: #f8f9fa; border-radius: 6px; padding: 15px;">
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">Drag nodes from here to the sandbox:</div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="background: white; padding: 10px; border-radius: 4px; border-left: 4px solid #007bff; cursor: pointer;">
                                <strong>üë§ Person Node</strong><br>
                                <small>Drag to add a person</small>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 4px; border-left: 4px solid #28a745; cursor: pointer;">
                                <strong>üè¢ Organization</strong><br>
                                <small>Drag to add an organization</small>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 4px; border-left: 4px solid #dc3545; cursor: pointer;">
                                <strong>üìÑ Document</strong><br>
                                <small>Drag to add a document</small>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 4px; border-left: 4px solid #ffc107; cursor: pointer;">
                                <strong>üåê Website</strong><br>
                                <small>Drag to add a website</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Faces Panel -->
                <div id="facesPanel" class="floating-panel faces-panel">
                    <div class="panel-header" id="facesHeader">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>üë§</span>
                            <span style="font-weight: 600; color: #6f42c1;">Faces</span>
                        </div>
                        <button onclick="togglePanel('faces')" class="panel-close">√ó</button>
                    </div>
                    <div style="flex: 1; overflow-y: auto; background: #f8f9fa; border-radius: 6px; padding: 15px;">
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">Drag faces to assign to people:</div>
                        <div id="facesLoading" style="text-align: center; padding: 20px;">
                            <div style="color: #666;">Loading faces...</div>
                        </div>
                        <div id="facesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px;">
                            <!-- Face thumbnails will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Artifacts Panel -->
                <div id="artifactsPanel" class="floating-panel artifacts-panel">
                    <div class="panel-header" id="artifactsHeader">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>üìé</span>
                            <span style="font-weight: 600; color: #fd7e14;">Artifacts</span>
                        </div>
                        <button onclick="togglePanel('artifacts')" class="panel-close">√ó</button>
                    </div>
                    <div style="flex: 1; overflow-y: auto; background: #f8f9fa; border-radius: 6px; padding: 15px;">
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">Drag files to the graph:</div>
                        <div id="artifactsLoading" style="text-align: center; padding: 20px;">
                            <div style="color: #666;">Loading files...</div>
                        </div>
                        <div id="artifactsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
                            <!-- Thumbnails will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Production Panel -->
                <div id="productionPanel" class="floating-panel production-panel">
                    <div class="panel-header" id="productionHeader">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>üîµ</span>
                            <span style="font-weight: 600; color: #28a745;">Production Graph</span>
                        </div>
                        <button onclick="togglePanel('production')" class="panel-close">√ó</button>
                    </div>
                    <div id="productionContainer" style="flex: 1; overflow: hidden; background: #fafafa; border-radius: 6px; position: relative; min-height: 0; width: 100%; height: calc(100% - 60px);"></div>
                </div>

                <!-- AI Assistant Panel -->
                <div id="ai-assistantPanel" class="floating-panel ai-assistant-panel open">
                    <div class="panel-header" id="ai-assistantHeader">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>ü§ñ</span>
                            <span style="font-weight: 600; color: #007bff;">AI Assistant</span>
                        </div>
                        <button onclick="togglePanel('ai-assistant')" class="panel-close">√ó</button>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                        <div style="background: #f8f9fa; border-radius: 6px; padding: 15px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">Quick Actions:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <button onclick="simulateChange()" style="padding: 8px; font-size: 12px; border: 1px solid #dee2e6; background: #f8f9fa; border-radius: 4px; cursor: pointer;">üîç Analyze</button>
                                <button onclick="simulateChange()" style="padding: 8px; font-size: 12px; border: 1px solid #dee2e6; background: #f8f9fa; border-radius: 4px; cursor: pointer;">‚úì Validate</button>
                                <button onclick="simulateChange()" style="padding: 8px; font-size: 12px; border: 1px solid #dee2e6; background: #f8f9fa; border-radius: 4px; cursor: pointer;">üîó Auto-Link</button>
                                <button onclick="simulateChange()" style="padding: 8px; font-size: 12px; border: 1px solid #dee2e6; background: #f8f9fa; border-radius: 4px; cursor: pointer;">üí° Suggest</button>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; border-radius: 6px; padding: 15px; flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 8px;">AI Insights:</div>
                            <div style="font-size: 13px; color: #666; line-height: 1.4;">
                                Ready to assist with graph analysis and suggestions. Click any quick action to interact with the sandbox.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tools Panel -->
                <div id="toolsPanel" class="floating-panel tools-panel">
                    <div class="panel-header" id="toolsHeader">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>üõ†Ô∏è</span>
                            <span style="font-weight: 600; color: #6c757d;">Tools</span>
                        </div>
                        <button onclick="togglePanel('tools')" class="panel-close">√ó</button>
                    </div>
                    <div style="flex: 1; background: #f8f9fa; border-radius: 6px; padding: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button style="padding: 15px; border: 1px solid #dee2e6; background: white; border-radius: 6px; cursor: pointer; text-align: center;">
                                <div style="font-size: 20px; margin-bottom: 5px;">üìä</div>
                                <small>Export</small>
                            </button>
                            <button style="padding: 15px; border: 1px solid #dee2e6; background: white; border-radius: 6px; cursor: pointer; text-align: center;">
                                <div style="font-size: 20px; margin-bottom: 5px;">üîÑ</div>
                                <small>Sync</small>
                            </button>
                            <button style="padding: 15px; border: 1px solid #dee2e6; background: white; border-radius: 6px; cursor: pointer; text-align: center;">
                                <div style="font-size: 20px; margin-bottom: 5px;">‚öôÔ∏è</div>
                                <small>Settings</small>
                            </button>
                            <button style="padding: 15px; border: 1px solid #dee2e6; background: white; border-radius: 6px; cursor: pointer; text-align: center;">
                                <div style="font-size: 20px; margin-bottom: 5px;">üîç</div>
                                <small>Search</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="../js/nexus-graph-control-v15.4.0.bundle.min.js"></script>

    <script>
        let sandboxRoot = null;
        let productionRoot = null;
        let debugMessages = [];
        let openPanels = ['ai-assistant'];
        let changesCount = 0;
        let initialDataLoaded = false;
        
        // Drag functionality for panels - each panel gets its own drag state
        function initializeDragFunctionality(panelId) {
            const panel = document.getElementById(panelId + 'Panel');
            const header = document.getElementById(panelId + 'Header');
            
            if (!panel || !header) return;
            
            // Local drag state for this panel
            let isDragging = false;
            let currentPanel = null;
            let dragOffset = { x: 0, y: 0 };
            
            // Remove any existing listeners first
            const newHeader = header.cloneNode(true);
            header.parentNode.replaceChild(newHeader, header);
            
            // Re-attach close button functionality
            const closeBtn = newHeader.querySelector('button');
            if (closeBtn) {
                closeBtn.onclick = () => window.togglePanel(panelId);
            }
            
            const startDrag = (e) => {
                // Don't start drag if clicking on close button
                if (e.target.tagName === 'BUTTON') return;
                
                isDragging = true;
                currentPanel = panel;
                panel.classList.add('dragging');
                
                const rect = panel.getBoundingClientRect();
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
                
                log('üîµ ' + panelId + ' panel drag started');
                e.preventDefault();
            };
            
            const drag = (e) => {
                if (!isDragging || !currentPanel) return;
                
                const x = e.clientX - dragOffset.x;
                const y = e.clientY - dragOffset.y;
                
                // Keep panel within viewport bounds
                const maxX = window.innerWidth - currentPanel.offsetWidth;
                const maxY = window.innerHeight - currentPanel.offsetHeight;
                
                const constrainedX = Math.max(80, Math.min(x, maxX)); // 80px for sidebar
                const constrainedY = Math.max(0, Math.min(y, maxY));
                
                currentPanel.style.left = constrainedX + 'px';
                currentPanel.style.top = constrainedY + 'px';
                currentPanel.style.right = 'auto';
                currentPanel.style.bottom = 'auto';
                
                e.preventDefault();
            };
            
            const stopDrag = () => {
                if (isDragging && currentPanel) {
                    isDragging = false;
                    currentPanel.classList.remove('dragging');
                    log('üîµ ' + panelId + ' panel drag ended');
                    currentPanel = null;
                }
            };
            
            newHeader.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }
        
        function log(message) {
            // Logging disabled for production
            console.log(message);
        }
        
        function updateChangesDisplay() {
            const shouldShow = initialDataLoaded && changesCount > 0;
            const contextBar = document.getElementById('contextBar');
            const changesText = document.getElementById('changesText');
            
            if (contextBar) {
                if (shouldShow) {
                    contextBar.classList.add('visible');
                } else {
                    contextBar.classList.remove('visible');
                }
            }
            
            if (changesText) {
                changesText.textContent = changesCount + ' ' + (changesCount === 1 ? 'change' : 'changes') + ' pending in sandbox';
            }
        }
        
        function simulateChange() {
            if (initialDataLoaded) {
                changesCount++;
                updateChangesDisplay();
                log('Change recorded: ' + changesCount + ' total');
            }
        }
        
        function checkBundle() {
            const hasReact = typeof React !== 'undefined';
            const hasReactDOM = typeof ReactDOM !== 'undefined';
            const hasNexus = typeof window.NexusGraphControl !== 'undefined';
            
            return hasReact && hasReactDOM && hasNexus;
        }
        
        function initializeSandbox() {
            if (!checkBundle()) {
                log('‚ùå Bundle not ready for sandbox');
                return;
            }
            
            log('üöÄ Initializing sandbox control...');
            const container = document.getElementById('sandboxContainer');
            
            try {
                if (sandboxRoot) {
                    sandboxRoot.unmount();
                    sandboxRoot = null;
                }
                
                const sampleData = {
                    nodes: [{
                        id: 'sandbox_person',
                        label: 'Sample Person',
                        type: 'person',
                        originalData: { name: 'Sample Person', type: 'person' }
                    }],
                    edges: []
                };
                
                const controlElement = React.createElement(window.NexusGraphControl.NexusGraphControl, {
                    data: sampleData,
                    hidePageHeader: true,
                    hideStatusBar: true,
                    useExternalMetadataEditor: false
                });
                
                sandboxRoot = ReactDOM.createRoot(container);
                sandboxRoot.render(controlElement);
                
                log('‚úÖ Sandbox control mounted');
                
                // Mark initial data as loaded - don't count as change
                initialDataLoaded = true;
                
                setTimeout(() => {
                    const hasContent = container.querySelector('svg') || 
                                     container.querySelector('canvas') ||
                                     container.innerHTML.includes('nexus');
                    log('üîç Sandbox content: ' + (hasContent ? 'Found ‚úÖ' : 'Missing ‚ùå'));
                }, 1000);
                
            } catch (error) {
                log('‚ùå Sandbox error: ' + error.message);
            }
        }
        
        // Observe panel resize and update Nexus control
        function observePanelResize(panelId) {
            const panel = document.getElementById(panelId + 'Panel');
            if (!panel || !window.ResizeObserver) return;
            
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    if (panelId === 'production' && productionRoot) {
                        // Re-initialize production control on resize
                        setTimeout(() => {
                            log('üìè Production panel resized, updating control');
                            initializeProduction();
                        }, 100);
                    }
                }
            });
            
            resizeObserver.observe(panel);
        }
        
        function initializeProduction() {
            if (!checkBundle()) {
                log('‚ùå Bundle not ready for production');
                return;
            }
            
            log('üéØ Initializing production control...');
            const container = document.getElementById('productionContainer');
            
            try {
                if (productionRoot) {
                    productionRoot.unmount();
                    productionRoot = null;
                }
                
                const sampleData = {
                    nodes: [{
                        id: 'prod_person',
                        label: 'Sarah Smith',
                        type: 'person',
                        originalData: { name: 'Sarah Smith', type: 'person', role: 'Product Manager' }
                    }, {
                        id: 'prod_org',
                        label: 'TechCorp Inc.',
                        type: 'organization',
                        originalData: { name: 'TechCorp Inc.', type: 'organization' }
                    }],
                    edges: [{
                        id: 'edge_1',
                        from: 'prod_person',
                        to: 'prod_org',
                        label: 'works_at'
                    }]
                };
                
                // Set container dimensions explicitly
                container.style.width = '100%';
                container.style.height = '100%';
                container.style.position = 'absolute';
                container.style.top = '0';
                container.style.left = '0';
                container.style.right = '0';
                container.style.bottom = '0';
                
                const controlElement = React.createElement(window.NexusGraphControl.NexusGraphControl, {
                    data: sampleData,
                    hidePageHeader: true,
                    hideStatusBar: true,
                    useExternalMetadataEditor: false,
                    width: '100%',
                    height: '100%',
                    style: { position: 'absolute', top: 0, left: 0, right: 0, bottom: 0 }
                });
                
                productionRoot = ReactDOM.createRoot(container);
                productionRoot.render(controlElement);
                
                log('‚úÖ Production control mounted');
                
                setTimeout(() => {
                    const hasContent = container.querySelector('svg') || 
                                     container.querySelector('canvas') ||
                                     container.innerHTML.includes('nexus');
                    log('üîç Production content: ' + (hasContent ? 'Found ‚úÖ' : 'Missing ‚ùå'));
                }, 1000);
                
            } catch (error) {
                log('‚ùå Production error: ' + error.message);
            }
        }
        
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId + 'Panel');
            if (!panel) {
                log('‚ùå Panel not found: ' + panelId);
                return;
            }
            
            const isOpen = panel.classList.contains('open');
            
            if (isOpen) {
                panel.classList.remove('open');
                log('üìã ' + panelId + ' panel closed');
                
                // Clean up production panel when closing
                if (panelId === 'production' && productionRoot) {
                    productionRoot.unmount();
                    productionRoot = null;
                    log('üßπ Production panel unmounted');
                }
            } else {
                panel.classList.add('open');
                log('üìã ' + panelId + ' panel opened');
                
                // Initialize drag functionality for any panel
                initializeDragFunctionality(panelId);
                
                // Initialize resize observer for all panels
                observePanelResize(panelId);
                
                // Special handling for production panel
                if (panelId === 'production') {
                    setTimeout(initializeProduction, 200);
                }
                
                // Load artifacts when panel is opened
                if (panelId === 'artifacts') {
                    // Initialize Firebase first if needed
                    if (!firebaseInitialized) {
                        initializeFirebase();
                        // Wait for auth state to be established
                        setTimeout(() => {
                            if (firebase.auth().currentUser) {
                                loadUserArtifacts();
                            }
                        }, 2000);
                    } else if (firebase.auth().currentUser) {
                        loadUserArtifacts();
                    } else {
                        // Try to wait for auth
                        log('‚è≥ Waiting for authentication...');
                        const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                            if (user) {
                                loadUserArtifacts();
                                unsubscribe(); // Stop listening after first auth
                            }
                        });
                    }
                }
                
                // Load faces when panel is opened
                if (panelId === 'faces') {
                    // Initialize Firebase first if needed
                    if (!firebaseInitialized) {
                        initializeFirebase();
                        // Wait for auth state to be established
                        setTimeout(() => {
                            if (firebase.auth().currentUser) {
                                loadUserFaces();
                            }
                        }, 2000);
                    } else if (firebase.auth().currentUser) {
                        loadUserFaces();
                    } else {
                        // Try to wait for auth
                        log('‚è≥ Waiting for authentication...');
                        const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                            if (user) {
                                loadUserFaces();
                                unsubscribe(); // Stop listening after first auth
                            }
                        });
                    }
                }
            }
            
            // Update toolbar button states
            updateToolbarStates();
        }
        
        function updateToolbarStates() {
            document.querySelectorAll('.toolbar-btn').forEach(btn => {
                const title = btn.getAttribute('title');
                let panelId = '';
                
                // Map button titles to panel IDs
                switch(title) {
                    case 'Node List': panelId = 'node-list'; break;
                    case 'Faces': panelId = 'faces'; break;
                    case 'Artifacts': panelId = 'artifacts'; break;
                    case 'Production Graph': panelId = 'production'; break;
                    case 'AI Assistant': panelId = 'ai-assistant'; break;
                    case 'Tools': panelId = 'tools'; break;
                }
                
                const panel = document.getElementById(panelId + 'Panel');
                
                if (panel && panel.classList.contains('open')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // Make togglePanel globally accessible
        window.togglePanel = togglePanel;
        
        // Firebase Integration Functions
        let firebaseInitialized = false;
        let firebaseConfig = {
            apiKey: "AIzaSyB0SdtkO7ngsXP7B0geafpDv_xEBAujel8",
            authDomain: "infitwin.firebaseapp.com",
            projectId: "infitwin",
            storageBucket: "infitwin.firebasestorage.app",
            messagingSenderId: "833139648849",
            appId: "1:833139648849:web:2768d8e37cf2a318018b70",
            measurementId: "G-PEJN4ZMCZ6"
        };
        
        function initializeFirebase() {
            if (firebaseInitialized) return;
            
            try {
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                firebaseInitialized = true;
                updateFirebaseStatus(true);
                log('üî• Firebase initialized');
                
                // Set up auth state listener
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        log('üë§ User logged in:', user.email);
                        // Update Firebase status
                        updateFirebaseStatus(true);
                    } else {
                        log('‚ùå No user logged in, attempting test login...');
                        // Try to login with test credentials
                        try {
                            await firebase.auth().signInWithEmailAndPassword('weezer@yev.com', '123456');
                            log('‚úÖ Test user logged in');
                        } catch (error) {
                            log('‚ùå Login failed:', error.message);
                            updateFirebaseStatus(false);
                        }
                    }
                });
            } catch (error) {
                log('‚ùå Firebase initialization error:', error);
                updateFirebaseStatus(false);
            }
        }
        
        function updateFirebaseStatus(connected) {
            const statusEl = document.getElementById('firebaseStatus');
            const statusText = document.getElementById('firebaseStatusText');
            if (statusEl && statusText) {
                if (connected) {
                    statusEl.classList.add('connected');
                    const user = firebase.auth().currentUser;
                    if (user) {
                        statusText.textContent = 'Connected: ' + user.email;
                    } else {
                        statusText.textContent = 'Connected';
                    }
                    statusEl.querySelector('span').style.background = '#28a745';
                } else {
                    statusEl.classList.remove('connected');
                    statusText.textContent = 'Disconnected';
                    statusEl.querySelector('span').style.background = '#dc3545';
                }
            }
        }
        
        function toggleFirebaseDropdown() {
            const dropdown = document.getElementById('firebaseDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
                
                // Initialize Firebase if not already done
                if (!firebaseInitialized) {
                    initializeFirebase();
                }
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.matches('.firebase-dropdown-btn') && !e.target.closest('.firebase-dropdown-btn')) {
                const dropdown = document.getElementById('firebaseDropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
            }
        });
        
        function getCurrentSandboxData() {
            // Get current sandbox state
            const nodes = [];
            const edges = [];
            
            // In a real implementation, we'd get this from the Nexus control
            if (sandboxRoot) {
                // Simulate getting data
                nodes.push({
                    id: 'sandbox_node_1',
                    label: 'Sample Node',
                    type: 'person',
                    _isSandbox: true,
                    interviewId: 'interview_' + Date.now(),
                    sessionId: 'session_' + Date.now()
                });
            }
            
            return { nodes, edges, changesCount };
        }
        
        async function syncToFirebase() {
            if (!firebaseInitialized) {
                alert('Firebase not initialized');
                return;
            }
            
            try {
                const sandboxData = getCurrentSandboxData();
                
                // Simulate saving to Firestore
                log('üì§ Syncing to Firebase...');
                
                // In real implementation:
                // await firebase.addDoc('sandbox_sessions', {
                //     ...sandboxData,
                //     timestamp: new Date(),
                //     userId: firebaseServices.auth.currentUser?.uid
                // });
                
                alert('Sandbox data synced to Firebase! \n' + 
                      'Nodes: ' + sandboxData.nodes.length + '\n' +
                      'Changes: ' + sandboxData.changesCount);
                      
                log('‚úÖ Sync complete');
            } catch (error) {
                alert('Failed to sync: ' + error.message);
                log('‚ùå Sync failed: ' + error.message);
            }
        }
        
        async function loadFromFirebase() {
            if (!firebaseInitialized) {
                alert('Firebase not initialized');
                return;
            }
            
            try {
                log('üì• Loading from Firebase...');
                
                // In real implementation:
                // const sessions = await firebase.getDocs('sandbox_sessions', [
                //     where('userId', '==', firebaseServices.auth.currentUser?.uid),
                //     orderBy('timestamp', 'desc'),
                //     limit(5)
                // ]);
                
                // Simulate loading
                const mockSessions = [
                    { id: '1', timestamp: new Date(), nodes: 5, changes: 3 },
                    { id: '2', timestamp: new Date(Date.now() - 86400000), nodes: 3, changes: 1 }
                ];
                
                const selected = prompt('Select session:\n' + 
                    mockSessions.map((s, i) => 
                        (i + 1) + '. ' + s.timestamp.toLocaleString() + ' (' + s.nodes + ' nodes)'
                    ).join('\n')
                );
                
                if (selected) {
                    alert('Session loaded!');
                    log('‚úÖ Loaded session');
                }
            } catch (error) {
                alert('Failed to load: ' + error.message);
                log('‚ùå Load failed: ' + error.message);
            }
        }
        
        async function uploadArtifacts() {
            if (!firebaseInitialized) {
                alert('Firebase not initialized');
                return;
            }
            
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,.pdf,.doc,.docx';
            input.multiple = true;
            
            input.onchange = async (e) => {
                const files = e.target.files;
                if (!files.length) return;
                
                try {
                    log('üìé Uploading ' + files.length + ' files...');
                    
                    // In real implementation:
                    // for (const file of files) {
                    //     const result = await firebase.uploadFile(file);
                    //     await firebase.addDoc('sandbox_artifacts', {
                    //         fileName: file.name,
                    //         downloadURL: result.downloadURL,
                    //         ...
                    //     });
                    // }
                    
                    alert('Uploaded ' + files.length + ' artifacts!');
                    log('‚úÖ Upload complete');
                } catch (error) {
                    alert('Upload failed: ' + error.message);
                    log('‚ùå Upload failed: ' + error.message);
                }
            };
            
            input.click();
        }
        
        function viewFirebaseData() {
            if (!firebaseInitialized) {
                alert('Firebase not initialized');
                return;
            }
            
            // Open a panel or modal to show Firebase data
            alert('Firebase Data Viewer\n\n' +
                  'Environment: ' + (firebaseServices.isParentApp ? 'Parent App' : 'Standalone') + '\n' +
                  'User: ' + (firebaseServices.auth.currentUser?.email || 'Not authenticated') + '\n\n' +
                  'Collections:\n' +
                  '- sandbox_sessions\n' +
                  '- sandbox_nodes\n' +
                  '- sandbox_artifacts');
        }
        
        // Make Firebase functions globally accessible
        window.toggleFirebaseDropdown = toggleFirebaseDropdown;
        window.syncToFirebase = syncToFirebase;
        window.loadFromFirebase = loadFromFirebase;
        window.uploadArtifacts = uploadArtifacts;
        window.viewFirebaseData = viewFirebaseData;
        
        // Load user artifacts from Firebase
        async function loadUserArtifacts() {
            if (!firebaseInitialized) {
                log('‚è≥ Firebase not initialized yet for artifacts');
                return;
            }
            
            const user = firebase.auth().currentUser;
            if (!user) {
                log('‚ùå No user logged in for artifacts');
                const loadingEl = document.getElementById('artifactsLoading');
                if (loadingEl) {
                    loadingEl.innerHTML = '<div style="color: #666;">Please log in to see files</div>';
                }
                return;
            }
            
            log('üìé Loading artifacts for user:', user.email, 'UID:', user.uid);
            
            const gridEl = document.getElementById('artifactsGrid');
            const loadingEl = document.getElementById('artifactsLoading');
            
            if (!gridEl || !loadingEl) {
                log('‚ùå Missing DOM elements for artifacts');
                return;
            }
            
            try {
                // Get user's files from Firestore
                const db = firebase.firestore();
                const filesRef = db.collection('users').doc(user.uid).collection('files');
                log('üîç Querying path: users/' + user.uid + '/files');
                
                // Try a simpler query first
                const snapshot = await filesRef.limit(50).get();
                
                log('üìä Query completed. Empty:', snapshot.empty, 'Size:', snapshot.size);
                
                if (snapshot.empty) {
                    loadingEl.innerHTML = '<div style="color: #666;">No files uploaded yet. <a href="../pages/my-files.html" style="color: #6B46C1;">Upload files</a></div>';
                    return;
                }
                
                loadingEl.style.display = 'none';
                gridEl.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const file = doc.data();
                    log('üìÑ File:', doc.id, file.fileName || 'Unnamed');
                    const thumbnail = createArtifactThumbnail(doc.id, file);
                    gridEl.appendChild(thumbnail);
                });
                
                log('‚úÖ Loaded', snapshot.size, 'artifacts');
            } catch (error) {
                log('‚ùå Error loading artifacts:', error.message);
                console.error('Full error:', error);
                loadingEl.innerHTML = '<div style="color: #EF4444;">Error: ' + error.message + '</div>';
                
                // Check if it's a permission error
                if (error.code === 'permission-denied') {
                    loadingEl.innerHTML = '<div style="color: #EF4444;">Permission denied. Please check Firestore rules.</div>';
                } else if (error.message && error.message.includes('index')) {
                    // Try without orderBy if it's an index issue
                    try {
                        log('üîÑ Retrying without orderBy...');
                        const snapshot = await firebase.firestore()
                            .collection('users').doc(user.uid).collection('files')
                            .limit(50).get();
                        
                        if (!snapshot.empty) {
                            loadingEl.style.display = 'none';
                            gridEl.innerHTML = '';
                            
                            snapshot.forEach(doc => {
                                const file = doc.data();
                                const thumbnail = createArtifactThumbnail(doc.id, file);
                                gridEl.appendChild(thumbnail);
                            });
                            
                            log('‚úÖ Loaded', snapshot.size, 'artifacts (without orderBy)');
                        }
                    } catch (retryError) {
                        log('‚ùå Retry also failed:', retryError.message);
                    }
                }
            }
        }
        
        // Create draggable thumbnail for artifact
        function createArtifactThumbnail(fileId, fileData) {
            const div = document.createElement('div');
            div.className = 'artifact-thumbnail';
            div.draggable = true;
            div.dataset.fileId = fileId;
            div.dataset.fileName = fileData.fileName || fileData.name || 'Unnamed';
            div.dataset.fileType = fileData.fileType || 'document';
            div.dataset.downloadUrl = fileData.downloadURL || '';
            
            // Determine content based on file type
            if (fileData.thumbnailURL) {
                // Use thumbnail if available
                div.innerHTML = `
                    <img src="${fileData.thumbnailURL}" alt="${fileData.fileName}" />
                    <div class="artifact-thumbnail-name">${fileData.fileName || 'Unnamed'}</div>
                `;
            } else if (fileData.fileType && fileData.fileType.startsWith('image/')) {
                // Use download URL for images without thumbnails
                div.innerHTML = `
                    <img src="${fileData.downloadURL}" alt="${fileData.fileName}" />
                    <div class="artifact-thumbnail-name">${fileData.fileName || 'Unnamed'}</div>
                `;
            } else {
                // Use icon for non-image files
                const icon = getFileIcon(fileData.fileType);
                div.innerHTML = `
                    <div class="artifact-thumbnail-icon">${icon}</div>
                    <div class="artifact-thumbnail-name">${fileData.fileName || 'Unnamed'}</div>
                `;
            }
            
            // Add drag event handlers
            div.addEventListener('dragstart', handleArtifactDragStart);
            div.addEventListener('dragend', handleArtifactDragEnd);
            
            return div;
        }
        
        // Get icon for file type
        function getFileIcon(fileType) {
            if (!fileType) return 'üìÑ';
            
            if (fileType.includes('pdf')) return 'üìë';
            if (fileType.includes('word') || fileType.includes('doc')) return 'üìù';
            if (fileType.includes('excel') || fileType.includes('sheet')) return 'üìä';
            if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'üìΩÔ∏è';
            if (fileType.includes('text')) return 'üìÑ';
            if (fileType.includes('zip') || fileType.includes('archive')) return 'üì¶';
            if (fileType.includes('video')) return 'üé•';
            if (fileType.includes('audio')) return 'üéµ';
            
            return 'üìÑ';
        }
        
        // Handle artifact drag start
        function handleArtifactDragStart(e) {
            e.target.classList.add('dragging');
            
            // Set drag data
            const dragData = {
                type: 'artifact',
                fileId: e.target.dataset.fileId,
                fileName: e.target.dataset.fileName,
                fileType: e.target.dataset.fileType,
                downloadUrl: e.target.dataset.downloadUrl
            };
            
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('application/json', JSON.stringify(dragData));
            
            log('üöÄ Dragging artifact:', dragData.fileName);
        }
        
        // Handle artifact drag end
        function handleArtifactDragEnd(e) {
            e.target.classList.remove('dragging');
        }
        
        // Load user faces from Firebase
        async function loadUserFaces() {
            if (!firebaseInitialized) {
                log('‚è≥ Firebase not initialized yet for faces');
                return;
            }
            
            const user = firebase.auth().currentUser;
            if (!user) {
                log('‚ùå No user logged in for faces');
                const loadingEl = document.getElementById('facesLoading');
                if (loadingEl) {
                    loadingEl.innerHTML = '<div style="color: #666;">Please log in to see faces</div>';
                }
                return;
            }
            
            log('üë§ Loading faces for user:', user.email, 'UID:', user.uid);
            
            const gridEl = document.getElementById('facesGrid');
            const loadingEl = document.getElementById('facesLoading');
            
            if (!gridEl || !loadingEl) {
                log('‚ùå Missing DOM elements for faces');
                return;
            }
            
            try {
                // Get user's files from Firestore
                const db = firebase.firestore();
                const filesRef = db.collection('users').doc(user.uid).collection('files');
                log('üîç Querying for files with faces: users/' + user.uid + '/files');
                
                // Query for files that have extracted faces
                const snapshot = await filesRef.limit(100).get();
                
                log('üìä Files query completed. Size:', snapshot.size);
                
                loadingEl.style.display = 'none';
                gridEl.innerHTML = '';
                
                let totalFaces = 0;
                
                // Iterate through files and extract faces
                snapshot.forEach(doc => {
                    const fileData = doc.data();
                    
                    // Check if file has extracted faces
                    if (fileData.extractedFaces && Array.isArray(fileData.extractedFaces) && fileData.extractedFaces.length > 0) {
                        log('üì∑ Found file with faces:', fileData.fileName, 'Face count:', fileData.extractedFaces.length);
                        
                        // Log first face structure to understand the data
                        if (fileData.extractedFaces[0]) {
                            log('üîç First face structure:', JSON.stringify(fileData.extractedFaces[0]));
                        }
                        
                        // Create face thumbnails for each extracted face
                        fileData.extractedFaces.forEach((face, index) => {
                            const faceThumbnail = createFaceThumbnail(doc.id, fileData, face, index);
                            gridEl.appendChild(faceThumbnail);
                            totalFaces++;
                        });
                    }
                });
                
                log('‚úÖ Loaded', totalFaces, 'faces from', snapshot.size, 'files');
                
                if (totalFaces === 0) {
                    loadingEl.style.display = 'block';
                    loadingEl.innerHTML = '<div style="color: #666;">No faces found. <a href="../pages/my-files.html" style="color: #6B46C1;">Upload and vectorize photos</a></div>';
                }
                
            } catch (error) {
                log('‚ùå Error loading faces:', error.message);
                console.error('Full error:', error);
                loadingEl.innerHTML = '<div style="color: #EF4444;">Error: ' + error.message + '</div>';
            }
        }
        
        // Create draggable face thumbnail
        function createFaceThumbnail(fileId, fileData, face, faceIndex) {
            const div = document.createElement('div');
            div.className = 'face-thumbnail';
            div.draggable = true;
            div.dataset.fileId = fileId;
            div.dataset.fileName = fileData.fileName || 'Unnamed';
            div.dataset.faceId = face.faceId || `face_${faceIndex}`;
            div.dataset.confidence = face.confidence || 0;
            
            // Create loading placeholder
            const loadingDiv = document.createElement('div');
            loadingDiv.style.width = '100%';
            loadingDiv.style.height = '100%';
            loadingDiv.style.background = '#f0f0f0';
            loadingDiv.style.display = 'flex';
            loadingDiv.style.alignItems = 'center';
            loadingDiv.style.justifyContent = 'center';
            loadingDiv.style.fontSize = '24px';
            loadingDiv.textContent = 'üë§';
            div.appendChild(loadingDiv);
            
            // Extract face using bounding box if available
            const boundingBox = face.boundingBox || face.BoundingBox;
            if (fileData.downloadURL && boundingBox) {
                log('üìê Extracting face with bounding box:', JSON.stringify(boundingBox));
                extractFaceFromImage(fileData.downloadURL, boundingBox)
                    .then(faceDataUrl => {
                        // Replace loading placeholder with extracted face
                        div.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = faceDataUrl;
                        img.alt = `Face ${faceIndex + 1}`;
                        div.appendChild(img);
                        
                        // Add confidence badge
                        const confidence = face.confidence || face.Confidence;
                        if (confidence) {
                            const confidenceBadge = document.createElement('div');
                            confidenceBadge.className = 'face-thumbnail-confidence';
                            confidenceBadge.textContent = Math.round(confidence) + '%';
                            div.appendChild(confidenceBadge);
                        }
                        
                        // Add name/label
                        const nameLabel = document.createElement('div');
                        nameLabel.className = 'face-thumbnail-name';
                        nameLabel.textContent = face.name || `Face ${faceIndex + 1}`;
                        div.appendChild(nameLabel);
                    })
                    .catch(error => {
                        log('‚ùå Failed to extract face:', error.message);
                        console.error('Face extraction error:', error);
                        // Show error state instead of placeholder
                        div.innerHTML = '<div style="color: red; font-size: 10px; padding: 5px;">Error</div>';
                    });
            } else {
                log('‚ö†Ô∏è No bounding box for face:', JSON.stringify(face));
                div.innerHTML = '<div style="color: orange; font-size: 10px; padding: 5px;">No box</div>';
            }
            
            // Store face data for drag operation
            div.dataset.faceData = JSON.stringify({
                fileId: fileId,
                fileName: fileData.fileName,
                faceId: face.faceId,
                faceIndex: faceIndex,
                confidence: face.confidence,
                boundingBox: face.boundingBox,
                emotions: face.emotions,
                ageRange: face.ageRange
            });
            
            // Add drag event handlers
            div.addEventListener('dragstart', handleFaceDragStart);
            div.addEventListener('dragend', handleFaceDragEnd);
            
            return div;
        }
        
        // Extract face from image using bounding box
        async function extractFaceFromImage(imageUrl, boundingBox) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous'; // Enable CORS for Firebase Storage URLs
                
                img.onload = function() {
                    // Create canvas for face extraction
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Check if boundingBox exists
                    if (!boundingBox) {
                        reject(new Error('BoundingBox is undefined'));
                        return;
                    }
                    
                    // Convert percentage-based coordinates to pixels
                    // Firebase/AWS uses: Left, Top, Width, Height (all 0-1)
                    const x = (boundingBox.Left || boundingBox.left || boundingBox.x || 0) * img.width;
                    const y = (boundingBox.Top || boundingBox.top || boundingBox.y || 0) * img.height;
                    const width = (boundingBox.Width || boundingBox.width || boundingBox.w || 0) * img.width;
                    const height = (boundingBox.Height || boundingBox.height || boundingBox.h || 0) * img.height;
                    
                    log('üìè Face extraction coords - X:', x, 'Y:', y, 'W:', width, 'H:', height);
                    
                    // Set canvas size to extracted face dimensions (80x80 for thumbnails)
                    const thumbnailSize = 80;
                    canvas.width = thumbnailSize;
                    canvas.height = thumbnailSize;
                    
                    // Draw the face region from the source image, scaled to thumbnail size
                    ctx.drawImage(
                        img,
                        x,                  // Source X (pixels)
                        y,                  // Source Y (pixels)
                        width,              // Source Width (pixels)
                        height,             // Source Height (pixels)
                        0,                  // Destination X
                        0,                  // Destination Y
                        thumbnailSize,      // Destination Width
                        thumbnailSize       // Destination Height
                    );
                    
                    // Convert to data URL
                    const faceDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                    resolve(faceDataUrl);
                };
                
                img.onerror = function() {
                    reject(new Error('Failed to load image for face extraction'));
                };
                
                img.src = imageUrl;
            });
        }
        
        // Handle face drag start
        function handleFaceDragStart(e) {
            e.target.classList.add('dragging');
            
            const faceData = JSON.parse(e.target.dataset.faceData);
            const dragData = {
                type: 'face',
                ...faceData
            };
            
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('application/json', JSON.stringify(dragData));
            
            log('üöÄ Dragging face:', dragData.faceId, 'from', dragData.fileName);
        }
        
        // Handle face drag end
        function handleFaceDragEnd(e) {
            e.target.classList.remove('dragging');
        }
        
        window.addEventListener('load', () => {
            log('üì¶ Page loaded, checking scripts...');
            
            // Initialize Firebase first
            initializeFirebase();
            
            setTimeout(() => {
                if (checkBundle()) {
                    log('‚úÖ Ready for testing');
                    initializeSandbox();
                    
                    // Initialize drag for AI Assistant panel (starts open)
                    initializeDragFunctionality('ai-assistant');
                    // Initialize resize observer for AI Assistant
                    observePanelResize('ai-assistant');
                    updateToolbarStates();
                } else {
                    log('‚ùå Scripts not loaded properly');
                }
            }, 500);
        });
    </script>
    
    <!-- Centralized Navigation -->
    <script src="../js/navigation.js"></script>
</body>
</html>