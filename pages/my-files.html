<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Files - Infitwin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/components/button.css">
    <link rel="stylesheet" href="../css/file-management.css">
    <link rel="stylesheet" href="../css/pages/my-files.css">
    
    <!-- Import map for Firebase -->
    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js",
            "firebase/functions": "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js"
        }
    }
    </script>
    <link rel="stylesheet" href="../css/components/navigation.css">
</head>
<body>
    <div class="symphony-dashboard">
        <!-- Sidebar Navigation -->
        <div class="sidebar-nav-container"></div>

        <!-- Main Content Wrapper -->
        <div class="main-content-wrapper">
            <!-- Fixed Header with Storage Indicator -->
            <div class="fixed-header">
                <div class="header-content">
                    <h1 class="page-title">My Files</h1>
                    <div class="vectorization-quota" id="vectorizationQuota">
                        <svg class="quota-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <span class="quota-label">Photo Vectorization</span>
                        <div class="quota-progress">
                            <div class="quota-bar" id="quotaBar" style="width: 0%"></div>
                        </div>
                        <span class="quota-text" id="quotaText">0/10 this month</span>
                    </div>
                    <div class="storage-indicator">
                        <svg class="storage-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 12v3c0 1.657 3.134 3 7 3s7-1.343 7-3v-3c0 1.657-3.134 3-7 3s-7-1.343-7-3z"/>
                            <path d="M3 7v3c0 1.657 3.134 3 7 3s7-1.343 7-3V7c0 1.657-3.134 3-7 3S3 8.657 3 7z"/>
                            <path d="M17 5c0 1.657-3.134 3-7 3S3 6.657 3 5s3.134-3 7-3 7 1.343 7 3z"/>
                        </svg>
                        <div class="storage-details">
                            <div class="storage-text">Storage Used</div>
                            <div class="storage-bar-container">
                                <div class="storage-bar" id="storageBar"></div>
                            </div>
                        </div>
                        <div class="storage-percent" id="storagePercent">0%</div>
                    </div>
                </div>
            </div>

            <!-- Sticky Controls -->
            <div class="sticky-controls">
                <div class="controls-content">
                    <div class="search-container">
                        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <input type="text" class="search-box" placeholder="Search files by name, type, or content..." id="searchInput">
                    </div>
                    <div class="quick-filters">
                        <button class="filter-chip active" data-filter="all">All Files<span class="count" id="allCount">0</span></button>
                        <button class="filter-chip" data-filter="faces">With Faces<span class="count" id="facesCount">0</span></button>
                        <button class="filter-chip" data-filter="recent">Recent<span class="count" id="recentCount">0</span></button>
                    </div>
                    <button class="upload-btn" id="uploadBtn">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 3a1 1 0 0 1 .707.293l3 3a1 1 0 0 1-1.414 1.414L11 6.414V13a1 1 0 1 1-2 0V6.414L7.707 7.707a1 1 0 0 1-1.414-1.414l3-3A1 1 0 0 1 10 3z"/>
                            <path d="M3 9a1 1 0 0 1 1 1v5a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-5a1 1 0 1 1 2 0v5a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-5a1 1 0 0 1 1-1z"/>
                        </svg>
                        Upload
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <main class="symphony-content">
                <!-- Upload Zone -->
                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="fileInput" multiple hidden accept=".jpg,.jpeg,.png,.gif,.webp,.pdf,.doc,.docx,.txt,.rtf,.xls,.xlsx,.epub,.ged">
                    <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <p style="font-size: 1.25rem; font-weight: 700; color: #6B46C1; margin-bottom: 8px;">Drop files to upload</p>
                    <p style="color: #6b7280;">or click to browse from your computer</p>
                    <p style="color: #9ca3af; font-size: 0.875rem; margin-top: 8px;">Supports JPG, PNG, PDF, DOC up to 50MB</p>
                </div>

                <!-- Batch Actions -->
                <div class="batch-actions" id="batchActions" style="display: none;">
                    <div class="batch-actions-inner">
                        <span class="selected-count">
                            <span id="selectedCount">0</span> files selected
                        </span>
                        <div class="batch-buttons">
                            <button class="btn-batch-vectorize" id="vectorizeBtn">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/>
                                </svg>
                                Vectorize Selected
                            </button>
                            <button class="btn-batch-cancel" onclick="clearFileSelection()">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Upload Queue -->
                <div id="uploadQueue" class="upload-queue"></div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState">
                    <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h2 class="empty-title">No files match your filter</h2>
                    <p class="empty-text">Try adjusting your search or filters to find what you're looking for.</p>
                    <button class="clear-filters-btn" onclick="clearAllFilters()">Clear filters</button>
                </div>

                <!-- Loading Skeleton -->
                <div class="file-grid" id="loadingGrid" style="display: none;">
                    <div class="skeleton-card">
                        <div class="skeleton-thumbnail"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text small"></div>
                        </div>
                    </div>
                    <div class="skeleton-card">
                        <div class="skeleton-thumbnail"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text small"></div>
                        </div>
                    </div>
                    <div class="skeleton-card">
                        <div class="skeleton-thumbnail"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text small"></div>
                        </div>
                    </div>
                </div>

                <!-- Files Container -->
                <div id="filesContainer" class="file-grid">
                    <!-- Files will be dynamically inserted here -->
                </div>

                <!-- Faces Container -->
                <div id="facesContainer" class="faces-container" style="display: none;">
                    <div class="faces-header">
                        <h3>Extracted Faces</h3>
                        <p class="faces-subtitle">Faces detected from your vectorized images</p>
                    </div>
                    <div id="facesGrid" class="faces-grid">
                        <!-- Face thumbnails will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Loading your files...</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Face View Modal -->
    <div class="face-modal" id="faceModal">
        <div class="face-modal-content">
            <div class="face-modal-header">
                <h2 class="face-modal-title">Detected Faces - <span id="faceModalFilename"></span></h2>
                <button class="face-modal-close" onclick="closeFaceModal()">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                    </svg>
                </button>
            </div>
            <div class="face-modal-body">
                <div class="faces-grid" id="facesModalGrid">
                    <!-- Dynamic faces will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <svg class="modal-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <h3 class="modal-title">Delete File?</h3>
            <p class="modal-text">This action cannot be undone. This will permanently delete the file.</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel">Cancel</button>
                <button class="modal-btn modal-confirm">Delete</button>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content image-modal-content">
            <div class="image-modal-header">
                <h3 class="modal-title" id="imageModalTitle">Image Title</h3>
                <button class="modal-close" onclick="closeImageModal()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="image-modal-body">
                <div class="image-container">
                    <img id="imageModalImg" class="modal-image" alt="Full size image">
                </div>
                <div class="image-info">
                    <div class="image-metadata">
                        <span class="image-size" id="imageModalSize">Size</span>
                        <span class="image-date" id="imageModalDate">Date</span>
                        <span class="image-type" id="imageModalType">Type</span>
                    </div>
                    <div class="image-comments">
                        <h4>Comments</h4>
                        <div class="comments-list" id="imageCommentsList">
                            <div class="no-comments">No comments yet. Add the first one!</div>
                        </div>
                        <div class="add-comment">
                            <textarea id="newCommentText" placeholder="Add a comment..." rows="3"></textarea>
                            <button class="btn-primary" onclick="addImageComment()">Add Comment</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Text Viewer Modal -->
    <!-- Modal for viewing text file contents inline without downloading -->
    <!-- Provides similar experience to image viewer but for text files -->
    <div class="modal" id="textModal">
        <div class="modal-content text-modal-content">
            <div class="text-modal-header">
                <h3 class="modal-title" id="textModalTitle">Text File</h3>
                <button class="modal-close" onclick="closeTextModal()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="text-modal-body">
                <div class="text-container">
                    <pre id="textModalContent" class="text-content"></pre>
                </div>
                <div class="text-info">
                    <div class="text-metadata">
                        <span class="text-size" id="textModalSize">Size</span>
                        <span class="text-date" id="textModalDate">Date</span>
                        <span class="text-encoding" id="textModalEncoding">UTF-8</span>
                    </div>
                    <div class="text-actions">
                        <button class="btn-secondary" onclick="copyTextContent()">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                            </svg>
                            Copy Text
                        </button>
                        <button class="btn-secondary" onclick="downloadTextFile()">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 3a1 1 0 00-1 1v6.586L6.707 8.293a1 1 0 10-1.414 1.414l4 4a1 1 0 001.414 0l4-4a1 1 0 00-1.414-1.414L11 10.586V4a1 1 0 00-1-1z"/>
                                <path d="M3 13a1 1 0 00-1 1v2a2 2 0 002 2h12a2 2 0 002-2v-2a1 1 0 10-2 0v2H4v-2a1 1 0 00-1-1z"/>
                            </svg>
                            Download
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/navigation.js"></script>
    <script type="module">
        import { initializeMyFiles } from '../js/pages/my-files.js';
        
        // Initialize page when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeMyFiles();
        });
    </script>
</body>
</html>