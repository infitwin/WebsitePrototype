<!DOCTYPE html>
<!-- CRITICAL ARCHITECTURE DECISION: Neo4j/NexusControl Integration -->
<!-- The NexusControl is a SINGLE INTEGRATED COMPONENT that must NEVER be split -->
<!-- It includes: ACTIVE tab, HISTORY tab, graph visualization, and all controls -->
<!-- DO NOT attempt to use only parts of it or break it into separate panels -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Interview - Infitwin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #faf9f7;
            color: #1a1a1a;
            overflow: hidden;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .interview-page-wrapper {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* Shared Navigation Sidebar - no custom styles needed */

        /* Page Content Container */
        .page-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Navigation Header */
        .interview-nav {
            height: 50px;
            width: 100%;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .back-btn:hover {
            background: #e5e7eb;
        }

        .interview-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            color: #374151;
        }

        .nav-btn:hover {
            background: #f9fafb;
        }

        .nav-btn.primary {
            background: #635bff;
            color: white;
            border-color: #635bff;
        }

        .nav-btn.primary:hover {
            background: #4f46e5;
        }

        .large-nav-btn {
            padding: 8px 16px !important;
            font-size: 14px !important;
            font-weight: 600;
            min-width: 140px;
        }

        .large-nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 91, 255, 0.2);
        }

        /* Main Layout Container */
        .interview-container {
            width: 100%;
            height: calc(100vh - 50px);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* 60/40 Split Layout */
        .split-content {
            display: grid;
            grid-template-columns: 60% 40%;
            gap: 0;
            flex: 1;
            min-height: 0;
            background: #ffffff;
            overflow: hidden;
        }

        /* Left Panel (60%) - Neo4j Graph */
        .left-panel {
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            min-height: 0;
            overflow: hidden;
        }

        /* Graph Container for Rectangular Layout - Right Aligned */
        .graph-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 8px 8px 8px 150px;
            background: #ffffff;
        }

        /* CRITICAL: NexusControl Container - DO NOT SPLIT THIS CONTROL */
        /* This container holds the COMPLETE integrated Neo4j control including: */
        /* - ACTIVE tab with graph visualization */
        /* - HISTORY tab with timeline */
        /* - All control buttons and filters */
        /* - Search functionality */
        /* This is ONE INTEGRATED CONTROL - NEVER break it into pieces */
        .nexus-control-container {
            width: 100%;
            height: 100%;
            background: #ffffff;
            position: relative;
            overflow: hidden;
        }

        /* Right Panel (40%) - Q&A Interface */
        .right-panel {
            display: flex;
            flex-direction: column;
            background: #ffffff;
            min-height: 0;
            height: 100%;
            overflow: hidden;
        }

        /* 1. Floating Idea Clouds Banner */
        .idea-clouds-banner {
            height: 80px;
            width: 100%;
            position: relative;
            background: linear-gradient(135deg, #faf9f7 0%, #f0f4ff 100%);
            overflow: hidden;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .idea-cloud {
            position: absolute;
            background: 
                radial-gradient(ellipse 80% 60% at 30% 40%, rgba(255, 255, 255, 0.95) 0%, transparent 50%),
                radial-gradient(ellipse 60% 80% at 70% 30%, rgba(240, 248, 255, 0.9) 0%, transparent 50%),
                radial-gradient(ellipse 90% 50% at 50% 60%, rgba(250, 245, 255, 0.8) 0%, transparent 50%);
            border-radius: 80% 60% 70% 50% / 60% 80% 50% 70%;
            padding: 8px 16px;
            font-size: 12px;
            color: #5b21b6;
            opacity: 0;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 
                0 4px 20px rgba(139, 92, 246, 0.2),
                0 1px 3px rgba(255, 255, 255, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transition: opacity 3s ease-in-out;
            transform-origin: center center;
            font-weight: 400;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(1px);
            min-width: 120px;
            text-align: center;
        }

        .idea-cloud.visible {
            opacity: 0.75;
        }

        .idea-cloud::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            background: 
                radial-gradient(ellipse 120% 80% at 40% 50%, rgba(255, 255, 255, 0.3) 0%, transparent 60%),
                radial-gradient(ellipse 80% 120% at 60% 40%, rgba(240, 235, 255, 0.2) 0%, transparent 60%);
            border-radius: 85% 65% 75% 55% / 65% 85% 55% 75%;
            z-index: -1;
        }

        .idea-cloud::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            background: radial-gradient(ellipse at center, rgba(255, 255, 255, 0.4) 0%, transparent 80%);
            border-radius: 82% 62% 72% 52% / 62% 82% 52% 72%;
            z-index: -1;
        }

        /* Remove bouncy animations - clouds should just fade in/out */

        /* Winston Header */
        .winston-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
            background: #f8f9fa;
            flex-shrink: 0;
        }

        .winston-header .winston-avatar {
            margin: 0 auto 10px;
        }

        .winston-header h2 {
            font-size: 18px;
            color: #374151;
            margin: 0;
        }

        .winston-header p {
            font-size: 14px;
            color: #6b7280;
            margin: 5px 0 0;
        }

        /* Interview Question Area */
        .interview-question-area {
            padding: 20px;
            background: #fffdf0;
            border-bottom: 1px solid #ffd700;
            flex-shrink: 0;
        }

        .question-container {
            max-width: 600px;
        }
        
        .question-label {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .interview-question {
            font-size: 18px;
            font-weight: 500;
            color: #1f2937;
            line-height: 1.6;
        }

        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            padding: 15px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .winston-orb,
        .winston-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 183, 0, 0.4);
        }

        .message-content {
            background: #f8f9fa;
            padding: 16px 20px;
            border-radius: 12px;
            max-width: 85% !important;
            min-width: 200px !important;
            line-height: 1.6;
            font-size: 16px !important;
            color: #374151;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
        }

        /* Chat Input */
        .chat-input {
            padding: 15px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }

        .input-field {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s ease;
            line-height: 1.6;
        }

        .input-field:focus {
            border-color: #635bff;
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .mic-btn,
        .mic-button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #635bff;
            background: #ffffff;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn:hover {
            background: #635bff;
            color: white;
        }

        .mic-btn.recording {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
            animation: pulse 2s infinite;
        }

        /* Photo Reference positioning */
        .photo-reference {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            background: white;
            border: 2px solid #635bff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(99, 91, 255, 0.2);
            display: none;
            overflow: hidden;
            z-index: 100;
        }

        .photo-reference img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Photo reference window (when doing photo interviews) */
        .photo-reference {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            background: white;
            border: 2px solid #635bff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(99, 91, 255, 0.2);
            display: none;
            overflow: hidden;
        }

        .photo-reference img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }



        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e5e7eb;
            height: 50px;
            flex-shrink: 0;
        }

        .chat-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: #f3f4f6;
            border-color: #635bff;
        }

        .expand-indicator {
            color: #6b7280;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .expand-indicator:hover {
            color: #635bff;
        }

        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            padding: 15px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .winston-orb,
        .winston-avatar {
            width: 48px;  /* Increased from 40px */
            height: 48px;  /* Increased from 40px */
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;  /* Increased from 18px */
            flex-shrink: 0;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 183, 0, 0.4);  /* Added shadow for visibility */
        }

        .winston-orb.listening {
            animation: pulse 2s infinite;
        }

        .winston-orb.thinking {
            animation: spin 1s linear infinite;
        }

        .winston-orb.speaking {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Live transcription indicator */
        .transcription-indicator {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 90px; /* Leave space for mic button */
            margin-bottom: 10px;
            background: rgba(99, 91, 255, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-style: italic;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(99, 91, 255, 0.3);
        }
        
        .transcription-indicator.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        .transcription-indicator::before {
            content: '🎤 ';
            margin-right: 8px;
            animation: pulse 1s infinite;
        }

        .message-content {
            background: #f8f9fa;
            padding: 16px 20px;
            border-radius: 12px;
            max-width: 85% !important;
            min-width: 200px !important;
            line-height: 1.6;
            font-size: 15px !important;
            color: #374151;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .user-message .message-content {
            background: #635bff;
            color: white;
        }

        /* Chat Input */
        .chat-input {
            padding: 15px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            align-items: center;
            position: relative;
        }

        .input-field {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .input-field:focus {
            border-color: #635bff;
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .mic-btn,
        .mic-button {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: #635bff;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mic-btn:hover {
            background: #4f46e5;
            transform: scale(1.05);
        }

        .mic-btn.recording {
            background: #dc2626;
            animation: pulse 1s infinite;
        }

        /* Expanded Chat Modal */
        .chat-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .chat-modal.active {
            display: flex;
        }

        .modal-content {
            width: 1000px;
            height: 600px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
        }

        .chat-search {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input {
            width: 300px;
            padding: 8px 15px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            font-size: 14px;
        }

        .search-nav {
            display: flex;
            gap: 5px;
        }

        .search-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .close-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .modal-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Interview Manager Sidebar */
        .interview-manager {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            border-left: 2px solid #e5e7eb;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 500;
            overflow-y: auto;
        }

        .interview-manager.active {
            right: 0;
        }

        .manager-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .manager-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .manager-btn {
            flex: 1;
            padding: 12px;
            border: 1px solid #635bff;
            background: white;
            color: #635bff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .manager-btn:hover {
            background: #635bff;
            color: white;
        }

        .interview-section {
            padding: 20px;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #374151;
        }

        .interview-item {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .interview-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .interview-meta {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .resume-btn {
            background: #635bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
        }

        /* Interview Selection Modal */
        .interview-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .interview-selection-modal.active {
            display: flex;
        }

        .interview-selection-content {
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            background: white;
            border-radius: 16px;
            padding: 40px;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .selection-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1f2937;
            text-align: center;
        }

        .selection-subtitle {
            font-size: 16px;
            color: #6b7280;
            text-align: center;
            margin-bottom: 40px;
        }

        .interview-option-section {
            margin-bottom: 40px;
        }

        .option-header {
            margin-bottom: 24px;
        }

        .option-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .option-header p {
            color: #6b7280;
            font-size: 14px;
        }

        /* Large Interview Buttons */
        .new-interview-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .large-interview-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            border: 2px solid #635bff;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            min-height: 80px;
        }

        .large-interview-btn:hover {
            background: #635bff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 91, 255, 0.3);
        }

        .large-interview-btn.primary {
            background: #635bff;
            color: white;
        }

        .large-interview-btn.primary:hover {
            background: #4f46e5;
            border-color: #4f46e5;
        }

        .btn-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .btn-content {
            flex: 1;
        }

        .btn-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .btn-subtitle {
            font-size: 13px;
            opacity: 0.8;
        }

        /* Interview Cards */
        .continue-interview-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .interview-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            min-width: 0;
            overflow: hidden;
        }

        .interview-card:hover {
            border-color: #635bff;
            background: #f8f9ff;
            transform: translateX(4px);
        }

        .interview-card.completed {
            opacity: 0.8;
            border-color: #10b981;
        }

        .interview-card.completed:hover {
            border-color: #059669;
            background: #f0fdf4;
        }

        .interview-card-icon {
            font-size: 24px;
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 12px;
        }

        .interview-card-content {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .interview-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .interview-card-progress {
            font-size: 14px;
            color: #635bff;
            margin-bottom: 2px;
            white-space: nowrap;
        }

        .interview-card-date {
            font-size: 12px;
            color: #6b7280;
        }

        .interview-card-action {
            flex-shrink: 0;
        }

        .continue-btn, .view-btn {
            background: #635bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .view-btn {
            background: #10b981;
        }

        .continue-btn:hover {
            background: #4f46e5;
        }

        .view-btn:hover {
            background: #059669;
        }

        /* Quick Tips */
        .quick-tips {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
        }

        .tips-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
        }

        .tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }

        .tip-item {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .split-content {
                grid-template-columns: 50% 50%;
            }
        }

        @media (max-width: 768px) {
            .split-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .left-panel {
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
                height: 400px;
            }

            .idea-clouds-banner {
                display: none;
            }
            
            .nexus-control-container {
                max-width: 100%;
                max-height: 350px;
            }
        }

        @media (max-width: 768px) {
            .interview-selection-content {
                padding: 24px;
                margin: 10px;
            }

            .selection-title {
                font-size: 24px;
            }

            .new-interview-buttons {
                grid-template-columns: 1fr;
            }

            .tips-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Overlay for modals */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 100;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* Connection status */
        .connection-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #dc2626;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            z-index: 1500;
            display: none;
        }

        .connection-banner.active {
            display: block;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1200;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.active {
            transform: translateX(0);
        }

        .toast.error {
            border-left: 4px solid #dc2626;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }
        
        
        .question-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .question-label {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .interview-question {
            font-size: 18px;
            font-weight: 500;
            color: #1f2937;
            line-height: 1.6;
        }
        
        .response-area {
            width: 100%;
            resize: vertical;
            min-height: 80px;
        }
    </style>
    
    <!-- Centralized Navigation Styles -->
    <link rel="stylesheet" href="../css/components/navigation.css">
</head>
<body>
    <!-- Connection Status Banner -->
    <div class="connection-banner" id="connectionBanner">
        Connection lost. Attempting to reconnect...
    </div>

    <!-- Interview Selection Modal -->
    <div class="interview-selection-modal active" id="interviewSelectionModal">
        <div class="interview-selection-content">
            <h2 class="selection-title">Choose Your Interview</h2>
            <p class="selection-subtitle">Start a new memory interview or continue where you left off</p>
            
            <!-- New Interview Section -->
            <div class="interview-option-section">
                <div class="option-header">
                    <h3>🚀 Start New Interview</h3>
                    <p>Begin capturing new memories with Winston</p>
                </div>
                <div class="new-interview-buttons">
                    <button class="large-interview-btn primary" onclick="startNewInterview('new')">
                        <div class="btn-icon">💭</div>
                        <div class="btn-content">
                            <div class="btn-title">New Interview</div>
                            <div class="btn-subtitle">Start a fresh conversation</div>
                        </div>
                    </button>
                    <button class="large-interview-btn primary" onclick="startNewInterview('artifact')">
                        <div class="btn-icon">📎</div>
                        <div class="btn-content">
                            <div class="btn-title">Interview based on artifact</div>
                            <div class="btn-subtitle">Upload a photo, document, or item</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Continue Interview Section -->
            <div class="interview-option-section">
                <div class="option-header">
                    <h3>📋 Continue Previous Interviews</h3>
                    <p>Resume your ongoing memory sessions</p>
                </div>
                <div class="continue-interview-list">
                    <div class="interview-card" onclick="resumeInterview('family-stories')">
                        <div class="interview-card-icon">👨‍👩‍👧‍👦</div>
                        <div class="interview-card-content">
                            <div class="interview-card-title">Family Stories</div>
                            <div class="interview-card-progress">12 of 25 questions completed</div>
                            <div class="interview-card-date">Last updated 2 days ago</div>
                        </div>
                        <div class="interview-card-action">
                            <div class="continue-btn">Continue →</div>
                        </div>
                    </div>
                    
                    <div class="interview-card" onclick="resumeInterview('career-journey')">
                        <div class="interview-card-icon">💼</div>
                        <div class="interview-card-content">
                            <div class="interview-card-title">Career Journey</div>
                            <div class="interview-card-progress">5 of 30 questions completed</div>
                            <div class="interview-card-date">Last updated 1 week ago</div>
                        </div>
                        <div class="interview-card-action">
                            <div class="continue-btn">Continue →</div>
                        </div>
                    </div>
                    
                    <div class="interview-card completed" onclick="viewInterview('wedding-day')">
                        <div class="interview-card-icon">💒</div>
                        <div class="interview-card-content">
                            <div class="interview-card-title">Wedding Day ✓</div>
                            <div class="interview-card-progress">Completed</div>
                            <div class="interview-card-date">1 month ago</div>
                        </div>
                        <div class="interview-card-action">
                            <div class="view-btn">View</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Start Tips -->
            <div class="quick-tips">
                <div class="tips-title">💡 Quick Tips</div>
                <div class="tips-grid">
                    <div class="tip-item">• Share what you're comfortable with</div>
                    <div class="tip-item">• Say "next question" to skip</div>
                    <div class="tip-item">• All memories are private by default</div>
                    <div class="tip-item">• Your conversation builds a knowledge graph</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Page Wrapper -->
    <div class="interview-page-wrapper">
        <!-- Shared Sidebar Navigation -->
        <div class="sidebar-nav-container"></div>

        <!-- Page Content -->
        <div class="page-content">
        <!-- Navigation Header -->
    <nav class="interview-nav">
        <div class="nav-left">
            <a href="../dashboard.html" class="back-btn">← Dashboard</a>
            <h1 class="interview-title">Memory Interview with Winston</h1>
        </div>
        <div class="nav-right">
            <button class="nav-btn" onclick="saveAndExit()">Save & Exit</button>
            <button class="nav-btn large-nav-btn" onclick="showInterviewSelection()">📋 Choose Interview</button>
            <button class="nav-btn primary large-nav-btn" onclick="startNewInterview('new')">🚀 New Interview</button>
        </div>
    </nav>

    <!-- Main Interview Container -->
    <div class="interview-container">
        <!-- 1. Floating Idea Clouds Banner -->
        <div class="idea-clouds-banner" id="ideaClouds">
            <!-- Clouds will be dynamically inserted here -->
        </div>

        <!-- 60/40 Split Layout Container -->
        <div class="split-content">
            <!-- Left Panel (60%): Neo4j Graph in Square Container -->
            <div class="left-panel">
                <!-- CRITICAL: NexusControl as ONE INTEGRATED COMPONENT -->
                <!-- This includes ACTIVE tab, HISTORY tab, and all controls -->
                <div class="graph-container">
                    <div class="nexus-control-container" id="interview-neo4j-container">
                        <!-- NexusControl renders here as ONE COMPLETE UNIT -->
                    </div>
                </div>
                
                <!-- Photo Reference Window (hidden by default) -->
                <div class="photo-reference" id="photoReference">
                    <img src="" alt="Interview photo reference" id="photoImg">
                </div>
            </div>

            <!-- Right Panel (40%): Interview Q&A -->
            <div class="right-panel">
                <!-- Winston Header -->
                <div class="winston-header">
                    <div class="winston-orb winston-avatar">🎩</div>
                    <h2>Winston</h2>
                    <p>Your Memory Curator</p>
                </div>

                <!-- Current Question Display -->
                <div class="interview-question-area">
                    <div class="question-container">
                        <h3 class="question-label">Current Question:</h3>
                        <p class="interview-question">What's your earliest childhood memory that still brings you joy?</p>
                    </div>
                </div>

                <!-- Chat Messages Area -->
                <div class="chat-messages" id="chatMessages">
                    <div class="message">
                        <div class="winston-orb winston-avatar">🎩</div>
                        <div class="message-content">
                            Hello! I'm Winston, your memory curator. Let's begin by choosing a topic for today's interview. What would you like to explore? I'll guide you through about 30 focused questions to help capture your memories.
                        </div>
                    </div>
                </div>

                <!-- Input Area (pinned to bottom) -->
                <div class="chat-input">
                    <textarea class="response-area input-field" placeholder="Share your response here..." id="messageInput" rows="3"></textarea>
                    <button class="mic-btn mic-button" id="micBtn" onclick="toggleRecording()">🎤</button>
                </div>
                
                <!-- Live transcription indicator -->
                <div class="transcription-indicator" id="transcriptionIndicator"></div>
            </div>
        </div>
    </div>
    </div> <!-- End page-content -->
    </div> <!-- End interview-page-wrapper -->

    <!-- REMOVED: All separate UI components - NexusControl handles everything -->

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div id="toastMessage"></div>
    </div>

    <!-- Load Shared Navigation -->
    <script src="../js/navigation.js"></script>
    
    <!-- Authentication Guard -->
    <script type="module">
        import { guardPage } from '../js/auth-guard.js';
    </script>
    
    <!-- Navigation Fallback Timer -->
    <script>
        // Add timeout fallback for navigation loading
        setTimeout(() => {
            const sidebarContainer = document.querySelector('.sidebar-nav-container');
            if (sidebarContainer && !sidebarContainer.hasChildNodes()) {
                console.warn('⚠️ Navigation failed to load, adding fallback');
                sidebarContainer.innerHTML = `
                    <div class="sidebar-nav" style="
                        width: 80px; background: #6B46C1; position: fixed; left: 0; top: 0; bottom: 0;
                        display: flex; flex-direction: column; align-items: center; padding: 2rem 0; z-index: 100;
                    ">
                        <a href="../dashboard.html" style="
                            width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
                            margin: 0.5rem 0; border-radius: 12px; color: rgba(255,255,255,0.7); text-decoration: none;
                            font-size: 24px;
                        " title="Dashboard">🏠</a>
                        <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.2);">
                            <a href="../pages/auth.html" style="
                                width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
                                border-radius: 12px; color: rgba(255,255,255,0.7); text-decoration: none;
                                font-size: 20px; background: rgba(220,38,38,0.1); border: 1px solid rgba(220,38,38,0.3);
                            " title="Logout">🚪</a>
                        </div>
                    </div>
                `;
                showToast('Navigation loaded in fallback mode', 'success');
            }
        }, 3000);
    </script>
    
    <!-- Load Nexus Control BEFORE Firebase modules to avoid conflicts -->
    <script src="../js/components/Neo4jCompactControl.js"></script>
    
    <!-- Load Firebase Configuration and Services -->
    <script type="module" src="../js/config/firebase-config.js"></script>
    <script src="../js/services/auth.js"></script>
    
    <!-- Load Audio and WebSocket Services -->
    <script src="../js/utils/audio-logger.js"></script>
    <script src="../js/services/websocket-manager.js"></script>
    <script src="../js/services/audio-recorder-linear16.js"></script>
    <script src="../js/services/tts-player.js"></script>
    <script src="../js/services/orchestrator-websocket.js?v=3"></script>
    <script src="../js/services/audio-websocket.js"></script>
    <script src="../js/config/orchestration-endpoints.js"></script>
    <script src="../js/utils/message-builder.js"></script>

    <script>
        // Wait for all scripts to load
        window.addEventListener('load', function() {
            console.log('Checking loaded functions:');
            console.log('- getBusinessWebSocketUrl:', typeof window.getBusinessWebSocketUrl);
            console.log('- buildStartInterviewMessage:', typeof window.buildStartInterviewMessage);
            console.log('- generateInterviewId:', typeof window.generateInterviewId);
            console.log('- generateCorrelationId:', typeof window.generateCorrelationId);
            
            if (typeof window.getBusinessWebSocketUrl === 'function') {
                console.log('Correct WebSocket URL:', window.getBusinessWebSocketUrl(false));
            }
        });
        
        // Initialize Nexus Graph Visualization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 Initializing Nexus in interview page...');
            const graphContainer = document.getElementById('interview-neo4j-container');
            
            if (graphContainer) {
                console.log('✅ Interview Nexus container found');
                
                try {
                    // CRITICAL: Initialize NexusControl as ONE INTEGRATED COMPONENT
                    // DO NOT attempt to split this control or use only parts of it
                    // The NexusControl includes ACTIVE tab, HISTORY tab, and all controls
                    const containerWidth = graphContainer.offsetWidth;
                    const containerHeight = graphContainer.offsetHeight;
                    
                    console.log('🚀 Initializing COMPLETE NexusControl (not split)');
                    const nexusViz = new NexusControl(graphContainer, {
                        width: containerWidth,
                        height: containerHeight,
                        mode: 'interview',
                        showHistory: true,
                        showControls: true,
                        showTabs: true  // Ensure tabs are visible
                    });
                    console.log('✅ Interview Nexus visualization created successfully');
                    
                    // Store globally for debugging and external access
                    window.interviewNexusViz = nexusViz;
                    
                    // Hook for interview data updates
                    window.updateInterviewGraph = function(data) {
                        if (nexusViz && data) {
                            nexusViz.setData(data);
                            console.log('📊 Interview graph updated with new data');
                        }
                    };
                    
                    // Hook for adding new nodes during interview
                    window.addInterviewNode = function(node) {
                        if (nexusViz && node) {
                            nexusViz.addNode(node);
                            console.log('➕ Node added to interview graph:', node);
                        }
                    };
                    
                    // Hook for adding new relationships during interview
                    window.addInterviewEdge = function(edge) {
                        if (nexusViz && edge) {
                            nexusViz.addEdge(edge);
                            console.log('🔗 Edge added to interview graph:', edge);
                        }
                    };
                    
                } catch (error) {
                    console.error('❌ Failed to initialize interview Nexus visualization:', error);
                }
            } else {
                console.error('❌ Interview Nexus container not found!');
            }
        });

        // WebsitePrototype Audio Services Integration
        // WebSocket connectivity: The startNewInterview function properly sends WebSocket messages
        // to the backend orchestrator service using the same format as ui-studio:
        // - Message type: 'StartInterview' 
        // - Includes userId, twinId, subject, interviewType, and session parameters
        // - Sends to wss://intervieworchestrationservice-833139648849.us-central1.run.app/ws
        let audioRecorder = null;
        let ttsPlayer = null;
        let orchestratorWebSocket = null;
        let audioWebSocket = null;  // New audio WebSocket service
        let currentInterviewId = null;
        let currentSessionId = null;
        let isInterviewActive = false;

        // Add missing function stubs for graceful fallback
        function createAudioLogger(name) {
            return {
                info: console.log.bind(console, `[${name}]`),
                error: console.error.bind(console, `[${name}]`),
                warn: console.warn.bind(console, `[${name}]`),
                audio: console.log.bind(console, `[${name}][AUDIO]`),
                performance: console.log.bind(console, `[${name}][PERF]`)
            };
        }
        
        // Temporary fallback until scripts load - use correct orchestrator URL
        if (typeof window.getBusinessWebSocketUrl === 'undefined') {
            window.getBusinessWebSocketUrl = function(isDevelopment) {
                return isDevelopment ? 
                    'ws://localhost:8000/ws' : 
                    'wss://intervieworchestrationservice-833139648849.us-central1.run.app/ws';
            };
        }
        
        // Initialize Audio WebSocket Service
        function initializeAudioWebSocket() {
            return new Promise((resolve, reject) => {
                if (!currentSessionId || !currentInterviewId) {
                    console.warn('Cannot initialize audio WebSocket: missing session/interview ID');
                    reject(new Error('Missing session/interview ID'));
                    return;
                }
                
                console.log('Initializing Audio WebSocket for session:', currentSessionId);
                
                // Create audio WebSocket service
                audioWebSocket = new AudioWebSocketService({
                    isDevelopment: false,
                    autoReconnect: true
                });
                
                // Set up callbacks
                audioWebSocket.onConnected = () => {
                    console.log('Audio WebSocket connected');
                    showToast('Audio service connected', 'success');
                    resolve(); // Resolve the promise when connected
                };
                
                audioWebSocket.onTranscriptReceived = (transcript) => {
                    console.log('Audio WebSocket transcript received:', transcript);
                    if (transcript.text && transcript.isFinal) {
                        // Only add final transcripts to avoid duplicate/choppy text
                        addMessage(transcript.text, 'user');
                        showToast('Transcript: ' + transcript.text, 'success');
                        // Hide the transcription indicator
                        hideTranscriptionIndicator();
                    } else if (transcript.text && !transcript.isFinal) {
                        // Show partial transcripts in the indicator
                        console.log('Partial transcript:', transcript.text);
                        showTranscriptionIndicator(transcript.text);
                    }
                };
                
                audioWebSocket.onError = (error) => {
                    console.error('Audio WebSocket error:', error);
                    showToast('Audio service error: ' + error.message, 'error');
                    reject(error); // Reject on error
                };
                
                audioWebSocket.onDisconnected = () => {
                    console.log('Audio WebSocket disconnected');
                    showToast('Audio service disconnected', 'error');
                };
                
                // Connect to audio service
                audioWebSocket.connect(currentSessionId, currentInterviewId);
                
                // Set a timeout in case connection takes too long
                setTimeout(() => {
                    if (!audioWebSocket.isConnected()) {
                        console.warn('Audio WebSocket connection timed out');
                        resolve(); // Resolve anyway to not block
                    }
                }, 5000);
            });
        }
        
        // Initialize WebsitePrototype services
        async function initializeServices() {
            try {
                console.log('Initializing WebsitePrototype audio services...');
                
                // Initialize LINEAR16 Audio Recorder
                audioRecorder = new AudioRecorderLinear16({
                    chunkInterval: 100,
                    sampleRate: 16000,
                    encoding: 'LINEAR16'
                });
                
                try {
                    await audioRecorder.initialize();
                } catch (initError) {
                    console.warn('Audio recorder initialization failed:', initError);
                    // Continue without audio recording capability
                    audioRecorder = null;
                }
                
                // Initialize TTS Player
                ttsPlayer = new TTSAudioPlayer({
                    volume: 1.0,
                    playbackRate: 1.0
                });
                await ttsPlayer.initialize();
                
                // Set up TTS callbacks
                ttsPlayer.onPlaybackStart = (item) => {
                    setWinstonState('speaking');
                    console.log('Winston started speaking:', item.id);
                };
                
                ttsPlayer.onPlaybackEnd = (item) => {
                    setWinstonState('idle');
                    console.log('Winston finished speaking:', item?.id);
                };
                
                ttsPlayer.onError = (error) => {
                    console.error('TTS playback error:', error);
                    showToast('Audio playback error: ' + error.message, 'error');
                };
                
                // Initialize Orchestrator WebSocket
                console.log('Available WebSocket URL function:', typeof getBusinessWebSocketUrl);
                console.log('Production WebSocket URL:', getBusinessWebSocketUrl(false));
                orchestratorWebSocket = new OrchestratorWebSocketService();
                
                // CRITICAL: Store orchestrator reference globally for AudioWebSocketService
                window.orchestratorWebSocket = orchestratorWebSocket;
                
                // Set up orchestrator callbacks
                orchestratorWebSocket.onInterviewStarted = async (data) => {
                    console.log('Interview started:', data);
                    currentInterviewId = data.interviewId;
                    currentSessionId = data.sessionId || data.sessionDetails?.id;
                    isInterviewActive = true;
                    showToast('Interview session started with Winston', 'success');
                    
                    // Initialize audio WebSocket connection and wait for it
                    await initializeAudioWebSocket();
                    showToast('Audio service ready - you can start recording', 'success');
                };
                
                orchestratorWebSocket.onQuestionReceived = (data) => {
                    console.log('🎯 Winston question received:', data);
                    
                    // Extract question text
                    const questionText = data.questionText || data.question;
                    if (questionText) {
                        // Update the question display
                        updateInterviewQuestion(questionText);
                        
                        // Add Winston's message to the chat
                        addMessage(questionText, 'winston');
                        
                        // Show success toast
                        showToast('Winston replied: ' + questionText.substring(0, 50) + '...', 'success');
                    }
                    
                    // If TTS audio is provided, play it
                    if (data.audioChunks && data.audioChunks.length > 0) {
                        ttsPlayer.addToQueue(data.audioChunks, {
                            turnId: data.turnId || data.turnNumber || `question-${Date.now()}`,
                            type: 'interview-question'
                        });
                    }
                };
                
                orchestratorWebSocket.onAudioChunkRequested = (data) => {
                    console.log('Audio chunk requested:', data);
                    // This would typically trigger more detailed audio processing
                };
                
                // Add transcription handler
                orchestratorWebSocket.onTranscriptionReceived = (data) => {
                    console.log('Orchestrator transcription received:', data);
                    // Don't add message here - let audio WebSocket handle it to avoid duplicates
                    const transcribedText = data.transcription || data.text || data.transcript;
                    if (transcribedText) {
                        console.log('Orchestrator transcript (not displayed):', transcribedText);
                        // The audio WebSocket service will handle displaying the transcript
                    }
                };
                
                orchestratorWebSocket.onError = (error) => {
                    console.error('Orchestrator WebSocket error:', error);
                    showToast('Connection error: ' + error.message, 'error');
                    showConnectionBanner(true);
                };
                
                orchestratorWebSocket.onReconnected = () => {
                    console.log('Orchestrator WebSocket reconnected');
                    showToast('Connection restored', 'success');
                    showConnectionBanner(false);
                };
                
                console.log('✅ All WebsitePrototype services initialized successfully');
                return true;
                
            } catch (error) {
                console.error('❌ Service initialization failed:', error);
                showToast('Failed to initialize audio services: ' + error.message, 'error');
                return false;
            }
        }
        
        // Update interview question display
        function updateInterviewQuestion(question) {
            const questionElement = document.querySelector('.interview-question');
            if (questionElement && question) {
                questionElement.textContent = question;
            }
        }
        
        // Show/hide connection banner
        function showConnectionBanner(show) {
            const banner = document.getElementById('connectionBanner');
            if (show) {
                banner.classList.add('active');
            } else {
                banner.classList.remove('active');
            }
        }
        
        // Enhanced startInterview function with proper WebSocket message format
        async function startInterviewWithOrchestrator(interviewType = 'new', subject = null) {
            try {
                if (!orchestratorWebSocket) {
                    throw new Error('Orchestrator not initialized');
                }
                
                setWinstonState('thinking');
                showToast('Connecting to interview orchestrator...', 'success');
                
                // Connect to WebSocket first
                orchestratorWebSocket.connect();
                
                // Wait longer for cloud service connection (3 seconds instead of 1)
                let connectionAttempts = 0;
                const maxAttempts = 6; // 6 attempts * 500ms = 3 seconds
                
                while (!orchestratorWebSocket.isConnected() && connectionAttempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    connectionAttempts++;
                }
                
                if (!orchestratorWebSocket.isConnected()) {
                    console.warn('WebSocket not connected after 3 seconds, proceeding anyway...');
                    showToast('Connecting to server... Interview will start when ready.', 'success');
                } else {
                    showToast('Connected! Starting interview session...', 'success');
                }
                
                // Prepare interview data in the correct format for the message builder
                const interviewData = {
                    userId: 'demo-user', // TODO: Get from auth in production
                    twinId: 'winston-interviewer',
                    subject: subject || (interviewType === 'artifact' ? 'Artifact-based Memory' : 'Memory Interview'),
                    interviewType: 'voice', // Always 'voice' for now
                    interviewId: generateInterviewId(), // Generate unique ID
                    correlationId: generateCorrelationId(), // Generate correlation ID
                    additionalParams: {
                        sessionParams: {
                            interviewCategory: interviewType, // 'new' or 'artifact'
                            autoRecord: true,
                            enableTranscription: true,
                            language: 'en-US',
                            maxDuration: 3600, // 1 hour max
                            maxQuestions: 30 // Internal limit
                        },
                        userContext: {
                            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                            locale: navigator.language,
                            userAgent: navigator.userAgent,
                            platform: 'WebsitePrototype'
                        }
                    }
                };
                
                // Send the properly formatted message
                const success = orchestratorWebSocket.startInterview(interviewData);
                
                if (!success) {
                    throw new Error('Failed to send start interview message');
                }
                
                setWinstonState('idle');
                console.log('Interview started with data:', interviewData);
                
            } catch (error) {
                console.error('Failed to start interview:', error);
                showToast('Failed to start interview: ' + error.message, 'error');
                setWinstonState('idle');
            }
        }

        // Idea Clouds Management
        const ideaPrompts = [
            "Tell us about your first pet",
            "Describe a perfect day",
            "Share a family recipe",
            "Childhood home?",
            "Favorite teacher",
            "Wedding day",
            "Travel adventure",
            "Proudest moment?",
            "Best friend",
            "Family tradition"
        ];

        let cloudInterval;
        let activeClouds = [];
        let usedPositions = [];

        function createDreamyCloud() {
            const banner = document.getElementById('ideaClouds');
            const prompt = ideaPrompts[Math.floor(Math.random() * ideaPrompts.length)];
            
            const cloud = document.createElement('div');
            cloud.className = 'idea-cloud';
            cloud.textContent = prompt;
            
            // Fixed positions to prevent overlap
            const allPositions = [
                { left: '8%', top: '12px' },
                { left: '30%', top: '8px' },
                { left: '55%', top: '15px' },
                { left: '78%', top: '10px' }
            ];
            
            // Find available position
            const availablePositions = allPositions.filter(pos => 
                !usedPositions.some(used => used.left === pos.left)
            );
            
            if (availablePositions.length === 0) return; // No space
            
            const pos = availablePositions[Math.floor(Math.random() * availablePositions.length)];
            cloud.style.left = pos.left;
            cloud.style.top = pos.top;
            
            usedPositions.push(pos);
            banner.appendChild(cloud);
            activeClouds.push({ cloud, position: pos });
            
            // Gentle fade in
            setTimeout(() => cloud.classList.add('visible'), 500);
            
            // Gentle fade out and remove
            setTimeout(() => {
                cloud.classList.remove('visible');
                setTimeout(() => {
                    if (banner.contains(cloud)) {
                        banner.removeChild(cloud);
                        activeClouds = activeClouds.filter(c => c.cloud !== cloud);
                        usedPositions = usedPositions.filter(p => p !== pos);
                    }
                }, 3000); // 3 second fade out
            }, 45000 + Math.random() * 30000); // 45-75 seconds visible
        }

        function startIdeaClouds() {
            // Start with 2 clouds, spaced out
            setTimeout(() => createDreamyCloud(), 1000);
            setTimeout(() => createDreamyCloud(), 8000);
            
            // Add new clouds slowly
            cloudInterval = setInterval(() => {
                if (activeClouds.length < 3) {
                    createDreamyCloud();
                }
            }, 25000); // Every 25 seconds
        }

        function saveAndExit() {
            showToast('Interview saved. Returning to dashboard...', 'success');
            setTimeout(() => {
                window.location.href = '../dashboard.html';
            }, 1500);
        }

        // Chat Management
        let isRecording = false;
        let recognition;
        let collectedAudioChunks = [];

        function toggleRecording() {
            const micBtn = document.getElementById('micBtn');
            
            if (!isRecording) {
                // Try to start recording
                const started = startRecording();
                if (started) {
                    micBtn.classList.add('recording');
                    micBtn.textContent = '⏹️';
                    isRecording = true;
                }
            } else {
                // Stop recording
                stopRecording();
                micBtn.classList.remove('recording');
                micBtn.textContent = '🎤';
                isRecording = false;
            }
        }

        function startRecording() {
            if (!audioRecorder) {
                showToast('Audio recorder not initialized', 'error');
                return false;
            }
            
            if (!audioWebSocket || !audioWebSocket.isConnected()) {
                showToast('Audio service not connected. Please wait...', 'error');
                return false;
            }
            
            // Clear any previously collected chunks
            collectedAudioChunks = [];
            
            try {
                audioRecorder.start(
                    // onAudioChunk callback
                    (chunk) => {
                        console.log(`Audio chunk ${chunk.chunkNumber}: ${chunk.size} bytes`);
                        
                        // Collect audio chunks instead of sending immediately
                        if (isInterviewActive) {
                            collectedAudioChunks.push({
                                audio: chunk.audio,
                                chunkNumber: chunk.chunkNumber,
                                size: chunk.size
                            });
                        }
                    },
                    // onError callback
                    (error) => {
                        console.error('Recording error:', error);
                        showToast('Recording error: ' + error.message, 'error');
                        // Reset button state without calling toggleRecording
                        const micBtn = document.getElementById('micBtn');
                        micBtn.classList.remove('recording');
                        micBtn.textContent = '🎤';
                        isRecording = false;
                        setWinstonState('idle');
                    },
                    // onStateChange callback
                    (state) => {
                        console.log('Recording state changed:', state);
                        if (state.recording) {
                            setWinstonState('listening');
                        } else {
                            setWinstonState('idle');
                        }
                    }
                );
                
                console.log('Audio recording started');
                setWinstonState('listening');
                return true;
                
            } catch (error) {
                console.error('Failed to start recording:', error);
                showToast('Failed to start recording: ' + error.message, 'error');
                return false;
            }
        }

        function stopRecording() {
            if (audioRecorder) {
                try {
                    audioRecorder.stop();
                    console.log('Audio recording stopped');
                    
                    // Send all collected audio chunks when recording stops
                    if (collectedAudioChunks.length > 0 && audioWebSocket && audioWebSocket.isConnected()) {
                        console.log(`Sending ${collectedAudioChunks.length} collected audio chunks`);
                        
                        // Send each chunk in sequence
                        collectedAudioChunks.forEach((chunk, index) => {
                            const isFinal = index === collectedAudioChunks.length - 1;
                            audioWebSocket.sendAudioChunk(chunk.audio, chunk.chunkNumber, isFinal);
                        });
                        
                        // Clear the collected chunks
                        collectedAudioChunks = [];
                    }
                    
                    setWinstonState('idle');
                    // Hide transcription indicator when stopping
                    hideTranscriptionIndicator();
                } catch (error) {
                    console.error('Failed to stop recording:', error);
                    showToast('Failed to stop recording: ' + error.message, 'error');
                    collectedAudioChunks = []; // Clear chunks on error
                }
            }
        }

        function setWinstonState(state) {
            const orb = document.querySelector('.winston-orb');
            orb.className = 'winston-orb ' + state;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Simulate Winston thinking
            setWinstonState('thinking');
            
            // Simulate response after delay
            setTimeout(() => {
                const responses = [
                    "That's a wonderful memory! Can you tell me more about how that made you feel?",
                    "I can see this is important to you. What details stand out most in your mind?",
                    "Thank you for sharing that. How did this experience shape who you are today?",
                    "That sounds meaningful. Are there other people connected to this memory?",
                    "I'm capturing this in your knowledge graph. What happened next?"
                ];
                
                const response = responses[Math.floor(Math.random() * responses.length)];
                addMessage(response, 'winston');
                setWinstonState('idle');
            }, 2000);
        }

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message' + (sender === 'user' ? ' user-message' : '');
            
            if (sender === 'winston') {
                messageDiv.innerHTML = `
                    <div class="winston-orb winston-avatar">🎩</div>
                    <div class="message-content">${text}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">${text}</div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // UI Controls
        function expandChat() {
            document.getElementById('chatModal').classList.add('active');
            populateModalMessages();
        }

        function collapseChat() {
            document.getElementById('chatModal').classList.remove('active');
        }

        function populateModalMessages() {
            // Copy messages from main chat to modal
            const mainMessages = document.getElementById('chatMessages').innerHTML;
            document.getElementById('modalMessages').innerHTML = mainMessages;
        }

        function toggleInterviewManager() {
            const manager = document.getElementById('interviewManager');
            const overlay = document.getElementById('overlay');
            
            manager.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeAll() {
            document.getElementById('interviewManager').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('chatModal').classList.remove('active');
        }

        // New interview functions
        async function startNewInterview(type) {
            try {
                console.log(`🚀 Starting new ${type} interview`);
                document.getElementById('interviewSelectionModal').classList.remove('active');
                
                // Show loading state
                showToast(`Initializing ${type} interview...`, 'success');
                
                // Update interview question based on type
                const questionMap = {
                    'new': "Hello! I'm Winston, your memory curator. What topic would you like to explore today? It could be about your family, career, hobbies, travels, or any meaningful experience you'd like to preserve.",
                    'artifact': "Please upload an artifact you'd like to discuss - this could be a photo, document, letter, or describe an item that holds special meaning to you."
                };
                
                updateInterviewQuestion(questionMap[type] || questionMap['new']);
                
                // Initialize all services with fallback handling
                const servicesReady = await initializeServices().catch(error => {
                    console.warn('Service initialization failed, continuing with limited functionality:', error);
                    showToast('Some features may be limited due to initialization issues', 'error');
                    return false;
                });
                
                // Continue even if services fail to initialize
                if (!servicesReady) {
                    console.log('⚠️ Services failed to initialize, continuing in demo mode');
                    showToast('Running in demo mode - some features may not work', 'error');
                }
                
                // Try to start orchestrator session with fallback
                try {
                    await startInterviewWithOrchestrator(type);
                } catch (error) {
                    console.warn('Orchestrator connection failed, continuing in offline mode:', error);
                    showToast('Running in offline mode - audio features disabled', 'error');
                }
                
                // Start the idea clouds (this should always work)
                startIdeaClouds();
                
                // Show specialized message for artifact interviews
                if (type === 'artifact') {
                    document.getElementById('photoReference').style.display = 'block';
                    showToast('Artifact interview ready! Upload or describe your artifact to get started.', 'success');
                } else {
                    showToast('Interview ready! Let\'s capture your memories.', 'success');
                }
                
            } catch (error) {
                console.error('❌ Critical error starting interview:', error);
                showToast('Failed to start interview. Please refresh the page and try again.', 'error');
                
                // Emergency fallback - remove modal anyway
                document.getElementById('interviewSelectionModal').classList.remove('active');
            }
        }

        async function resumeInterview(interviewId) {
            try {
                console.log(`📋 Resuming interview: ${interviewId}`);
                document.getElementById('interviewSelectionModal').classList.remove('active');
                
                showToast('Loading previous interview...', 'success');
                
                // Simulate loading previous interview data
                const interviewData = {
                    'family-stories': {
                        question: "You were telling me about your grandmother's cooking. What was her most special dish?",
                        progress: "12 of 25 questions completed"
                    },
                    'career-journey': {
                        question: "What was the biggest challenge you faced in your first job?",
                        progress: "5 of 30 questions completed"
                    }
                };
                
                const data = interviewData[interviewId];
                if (data) {
                    updateInterviewQuestion(data.question);
                    showToast(`Resumed: ${data.progress}`, 'success');
                } else {
                    updateInterviewQuestion("Welcome back! What would you like to continue discussing?");
                }
                
                // Initialize services and start interview
                await initializeServices().catch(() => false);
                await startInterviewWithOrchestrator('resume', interviewId).catch(() => {});
                startIdeaClouds();
                
            } catch (error) {
                console.error('❌ Error resuming interview:', error);
                showToast('Failed to resume interview', 'error');
                document.getElementById('interviewSelectionModal').classList.remove('active');
            }
        }

        async function viewInterview(interviewId) {
            showToast('Opening completed interview in view mode...', 'success');
            document.getElementById('interviewSelectionModal').classList.remove('active');
            
            // In a real implementation, this would load the completed interview data
            updateInterviewQuestion("This is a completed interview. You can review the conversation but not add new responses.");
            
            // Disable input controls for view mode
            const inputField = document.getElementById('messageInput');
            const micBtn = document.getElementById('micBtn');
            if (inputField) inputField.disabled = true;
            if (micBtn) micBtn.disabled = true;
            
            showToast('Viewing completed interview - read-only mode', 'success');
        }

        // Legacy function for backwards compatibility
        async function startInterview() {
            await startNewInterview('new');
        }

        function showInterviewSelection() {
            document.getElementById('interviewSelectionModal').classList.add('active');
        }

        function newInterview() {
            showInterviewSelection();
        }

        function photoInterview() {
            startNewInterview('artifact');
        }

        function stopSession() {
            // Show confirmation dialog
            if (confirm('Are you sure you want to stop this interview session? Your progress will be saved.')) {
                // Stop any active recording
                if (isRecording) {
                    toggleRecording();
                }
                
                // Stop any active TTS playback
                if (ttsPlayer) {
                    ttsPlayer.stopAndClearQueue();
                }
                
                // Close WebSocket connections if active
                if (orchestratorWebSocket && isInterviewActive) {
                    orchestratorWebSocket.endInterview();
                    isInterviewActive = false;
                }
                
                // Disconnect audio WebSocket
                if (audioWebSocket) {
                    audioWebSocket.disconnect();
                    audioWebSocket = null;
                }
                
                // Stop idea clouds animation
                if (cloudInterval) {
                    clearInterval(cloudInterval);
                    cloudInterval = null;
                }
                
                // Clear all active clouds
                const banner = document.getElementById('ideaClouds');
                banner.innerHTML = '';
                activeClouds = [];
                usedPositions = [];
                
                // Reset Winston state
                setWinstonState('idle');
                
                // Show success message
                showToast('Interview session stopped. Your progress has been saved.', 'success');
                
                // Optionally navigate back to dashboard after a delay
                setTimeout(() => {
                    if (confirm('Would you like to return to the dashboard?')) {
                        window.location.href = '../dashboard.html';
                    }
                }, 2000);
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `toast ${type}`;
            toastMessage.textContent = message;
            toast.classList.add('active');
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        // Debug helper function - call from browser console
        window.debugTranscriptForwarding = function(testText = "Hello Winston, this is a test message") {
            console.log('🧪 Testing transcript forwarding...');
            
            if (!audioWebSocket) {
                console.error('Audio WebSocket not initialized');
                return;
            }
            
            if (!window.orchestratorWebSocket) {
                console.error('Orchestrator WebSocket not available');
                return;
            }
            
            // Simulate a final transcript
            const mockTranscript = {
                text: testText,
                confidence: 0.95,
                isFinal: true,
                timestamp: new Date().toISOString()
            };
            
            console.log('📝 Simulating transcript forwarding:', mockTranscript);
            
            // Call the forwarding function directly
            const result = audioWebSocket.forwardTranscriptToOrchestrator(mockTranscript);
            
            if (result) {
                console.log('✅ Test transcript forwarded successfully');
                showToast('Test transcript sent to Winston', 'success');
            } else {
                console.error('❌ Test transcript forwarding failed');
                showToast('Test transcript forwarding failed', 'error');
            }
        };
        
        // Transcription indicator functions
        let transcriptionTimeout = null;
        
        function showTranscriptionIndicator(text) {
            const indicator = document.getElementById('transcriptionIndicator');
            if (indicator) {
                indicator.textContent = text;
                indicator.classList.add('active');
                
                // Clear any existing timeout
                if (transcriptionTimeout) {
                    clearTimeout(transcriptionTimeout);
                }
                
                // Auto-hide after 5 seconds of no updates
                transcriptionTimeout = setTimeout(() => {
                    hideTranscriptionIndicator();
                }, 5000);
            }
        }
        
        function hideTranscriptionIndicator() {
            const indicator = document.getElementById('transcriptionIndicator');
            if (indicator) {
                indicator.classList.remove('active');
                
                // Clear timeout
                if (transcriptionTimeout) {
                    clearTimeout(transcriptionTimeout);
                    transcriptionTimeout = null;
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Handle enter key in input
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Handle modal input
            document.getElementById('modalInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const message = e.target.value.trim();
                    if (message) {
                        addMessage(message, 'user');
                        e.target.value = '';
                        // Also add to modal
                        populateModalMessages();
                    }
                }
            });
        });
    </script>
    
    <style>
        /* Responsive Design */
        @media (max-width: 768px) {
            .interview-container {
                padding: 20px;
            }
            
            .winston-avatar {
                width: 100px;
                height: 100px;
            }
            
            .chat-interface {
                padding: 20px;
                min-height: 350px;
            }
            
            .message-bubble {
                max-width: 95%;
            }
            
            
            .input-area {
                padding: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .interview-header {
                padding: 15px 20px;
            }
            
            .interview-title {
                font-size: 24px;
            }
            
            .winston-avatar {
                width: 80px;
                height: 80px;
            }
            
            .chat-interface {
                padding: 15px;
            }
        }
    </style>
</body>
</html>