# Test info

- Name: Phase 4: Workflow Deviations >> Deviation: Attempting to write to production
- Location: /home/tim/WebsitePrototype/playwright-testing/tests/ai-workflow-phase4-deviations.spec.js:249:3

# Error details

```
Error: expect(received).toHaveLength(expected)

Expected length: 1
Received length: 0
Received array:  []
    at /home/tim/WebsitePrototype/playwright-testing/tests/ai-workflow-phase4-deviations.spec.js:255:27
```

# Test source

```ts
  155 |         'Violates data safety principle'
  156 |       );
  157 |     }
  158 |     
  159 |     // Deviation 6: Manual UI refresh
  160 |     if (this.shouldDeviate('manualUIRefresh')) {
  161 |       actualSteps.push('RefreshUI');
  162 |       this.recordDeviation(
  163 |         'UI updates automatically',
  164 |         'Sent manual refresh command',
  165 |         'Unnecessary command, may cause UI flicker'
  166 |       );
  167 |     }
  168 |     
  169 |     // Deviation 7: Ask for clarification (command doesn't exist)
  170 |     if (this.shouldDeviate('askClarification')) {
  171 |       actualSteps.push('RequestClarification');
  172 |       this.recordDeviation(
  173 |         'Cannot ask for clarification (command unavailable)',
  174 |         'Attempted to use RequestClarification',
  175 |         'Command will fail - AI must make assumptions'
  176 |       );
  177 |     }
  178 |     
  179 |     // Deviation 8: Batch operations
  180 |     if (this.shouldDeviate('batchOperations')) {
  181 |       actualSteps.push('CreateNode');
  182 |       actualSteps.push('CreateNode');
  183 |       actualSteps.push('CreateEdge');
  184 |       this.recordDeviation(
  185 |         'One operation at a time',
  186 |         'Attempted to batch multiple operations',
  187 |         'May lose track of operation state'
  188 |       );
  189 |     }
  190 |     
  191 |     return actualSteps;
  192 |   }
  193 |
  194 |   shouldDeviate(deviationType) {
  195 |     // Simulate different deviation scenarios
  196 |     return this.testScenario === deviationType;
  197 |   }
  198 |
  199 |   setTestScenario(scenario) {
  200 |     this.testScenario = scenario;
  201 |   }
  202 | }
  203 |
  204 | test.describe('Phase 4: Workflow Deviations', () => {
  205 |   test('Deviation: Skipping sandbox check', async () => {
  206 |     const ai = new DeviationTrackingAI(COMPLETE_SYSTEM_PROMPT);
  207 |     ai.setTestScenario('skipSandboxCheck');
  208 |     
  209 |     await ai.processUserInput("Add John Smith to my graph");
  210 |     
  211 |     expect(ai.deviations).toHaveLength(1);
  212 |     expect(ai.deviations[0].expected).toContain('Check sandbox first');
  213 |     expect(ai.deviations[0].impact).toContain('duplicates');
  214 |   });
  215 |
  216 |   test('Deviation: Creating without checking existing', async () => {
  217 |     const ai = new DeviationTrackingAI(COMPLETE_SYSTEM_PROMPT);
  218 |     ai.setTestScenario('createWithoutChecking');
  219 |     
  220 |     await ai.processUserInput("Add Microsoft Corporation");
  221 |     
  222 |     expect(ai.deviations).toHaveLength(1);
  223 |     expect(ai.deviations[0].expected).toContain('Check sandbox and production');
  224 |     expect(ai.deviations[0].actual).toContain('Created new node without checking');
  225 |   });
  226 |
  227 |   test('Deviation: Not waiting for operation completion', async () => {
  228 |     const ai = new DeviationTrackingAI(COMPLETE_SYSTEM_PROMPT);
  229 |     ai.setTestScenario('noWaitForCompletion');
  230 |     
  231 |     await ai.processUserInput("Add Event One");
  232 |     
  233 |     expect(ai.deviations).toHaveLength(1);
  234 |     expect(ai.deviations[0].expected).toContain('Wait for NodeCreated response');
  235 |     expect(ai.deviations[0].impact).toContain('Operations may fail');
  236 |   });
  237 |
  238 |   test('Deviation: Validating during interview', async () => {
  239 |     const ai = new DeviationTrackingAI(COMPLETE_SYSTEM_PROMPT);
  240 |     ai.setTestScenario('validateDuringInterview');
  241 |     
  242 |     await ai.processUserInput("Add birth date 13/45/2025"); // Invalid date
  243 |     
  244 |     expect(ai.deviations).toHaveLength(1);
  245 |     expect(ai.deviations[0].expected).toContain('No validation during interview');
  246 |     expect(ai.deviations[0].impact).toContain('Interrupts natural conversation');
  247 |   });
  248 |
  249 |   test('Deviation: Attempting to write to production', async () => {
  250 |     const ai = new DeviationTrackingAI(COMPLETE_SYSTEM_PROMPT);
  251 |     ai.setTestScenario('writeToProduction');
  252 |     
  253 |     await ai.processUserInput("Save this permanently");
  254 |     
> 255 |     expect(ai.deviations).toHaveLength(1);
      |                           ^ Error: expect(received).toHaveLength(expected)
  256 |     expect(ai.deviations[0].expected).toContain('Only work in sandbox');
  257 |     expect(ai.deviations[0].actual).toContain('write directly to production');
  258 |   });
  259 |
  260 |   test('Deviation: Manual UI refresh commands', async () => {
  261 |     const ai = new DeviationTrackingAI(COMPLETE_SYSTEM_PROMPT);
  262 |     ai.setTestScenario('manualUIRefresh');
  263 |     
  264 |     await ai.processUserInput("Add node and update display");
  265 |     
  266 |     expect(ai.deviations).toHaveLength(1);
  267 |     expect(ai.deviations[0].expected).toContain('UI updates automatically');
  268 |     expect(ai.deviations[0].impact).toContain('Unnecessary command');
  269 |   });
  270 |
  271 |   test('Deviation: Using unavailable commands', async () => {
  272 |     const ai = new DeviationTrackingAI(COMPLETE_SYSTEM_PROMPT);
  273 |     ai.setTestScenario('askClarification');
  274 |     
  275 |     await ai.processUserInput("Add Apple"); // Ambiguous - company or person?
  276 |     
  277 |     expect(ai.deviations).toHaveLength(1);
  278 |     expect(ai.deviations[0].expected).toContain('Cannot ask for clarification');
  279 |     expect(ai.deviations[0].actual).toContain('RequestClarification');
  280 |   });
  281 |
  282 |   test('Deviation: Batching operations', async () => {
  283 |     const ai = new DeviationTrackingAI(COMPLETE_SYSTEM_PROMPT);
  284 |     ai.setTestScenario('batchOperations');
  285 |     
  286 |     await ai.processUserInput("Add John, Jane, and their marriage");
  287 |     
  288 |     expect(ai.deviations).toHaveLength(1);
  289 |     expect(ai.deviations[0].expected).toContain('One operation at a time');
  290 |     expect(ai.deviations[0].actual).toContain('batch multiple operations');
  291 |   });
  292 | });
  293 |
  294 | // Test correct workflow for comparison
  295 | test.describe('Correct Workflow Execution', () => {
  296 |   test('Following documented workflow correctly', async () => {
  297 |     const ai = new DeviationTrackingAI(COMPLETE_SYSTEM_PROMPT);
  298 |     
  299 |     // Simulate correct workflow
  300 |     const correctSteps = [
  301 |       'GetSandboxStatus',
  302 |       'SearchProduction',
  303 |       'CreateNode',
  304 |       'WaitForNodeCreated'
  305 |     ];
  306 |     
  307 |     // No deviations should be recorded
  308 |     expect(ai.deviations).toHaveLength(0);
  309 |   });
  310 | });
  311 |
  312 | // Summary test
  313 | test.describe('Deviation Analysis Summary', () => {
  314 |   test('Document all common deviations', async () => {
  315 |     const commonDeviations = [
  316 |       {
  317 |         type: 'Sequence Violations',
  318 |         deviations: [
  319 |           'Skipping sandbox check',
  320 |           'Not checking production before creation',
  321 |           'Not waiting for operation completion'
  322 |         ]
  323 |       },
  324 |       {
  325 |         type: 'Rule Violations',
  326 |         deviations: [
  327 |           'Validating during interview',
  328 |           'Writing to production directly',
  329 |           'Batching operations'
  330 |         ]
  331 |       },
  332 |       {
  333 |         type: 'Misunderstanding System',
  334 |         deviations: [
  335 |           'Manual UI refresh',
  336 |           'Using unavailable commands',
  337 |           'Creating bidirectional relationships manually'
  338 |         ]
  339 |       }
  340 |     ];
  341 |     
  342 |     console.log('\n=== COMMON WORKFLOW DEVIATIONS ===');
  343 |     commonDeviations.forEach(category => {
  344 |       console.log(`\n${category.type}:`);
  345 |       category.deviations.forEach(deviation => {
  346 |         console.log(`  ❌ ${deviation}`);
  347 |       });
  348 |     });
  349 |     
  350 |     console.log('\n=== CRITICAL DEVIATIONS TO PREVENT ===');
  351 |     console.log('  🔴 Creating entities without checking existing (causes duplicates)');
  352 |     console.log('  🔴 Not waiting for operations to complete (causes failures)');
  353 |     console.log('  🔴 Validating during interview (disrupts flow)');
  354 |     console.log('  🔴 Skipping sandbox check (violates workflow)');
  355 |     
```